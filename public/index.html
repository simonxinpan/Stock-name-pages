<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- ... 省略 <head> ... -->
    <style>
        /* ... 省略之前的样式 ... */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); z-index: 40; }
        .modal-content { max-height: 80vh; }
        .prose h1, .prose h2 { font-weight: bold; margin-top: 1.25em; margin-bottom: 0.5em; line-height: 1.2; }
        .prose p { margin-bottom: 1.25em; line-height: 1.7; }
        .prose a { color: #3b82f6; text-decoration: underline; }
    </style>
</head>
<body class="bg-gray-50" x-data="liveStockApp()" x-init="init()" @beforeunload="cleanup()">
    
    <!-- ... 省略 nav 和 main HTML 结构，只在 main 内部修改新闻部分 ... -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6" x-show="!loading && quote" x-cloak>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-6">
                <!-- ... 省略 K线图部分 ... -->
                <div class="bg-white rounded-lg card-shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4" x-text="language === 'zh' ? '相关新闻' : 'Related News'"></h3>
                    <div class="max-h-96 overflow-y-auto space-y-3">
                        <template x-for="article in news.slice(0, 10)" :key="article.id">
                            <div @click="openArticleModal(article.url)" class="cursor-pointer border-b border-gray-100 pb-3 last:border-b-0"><div class="block hover:bg-gray-50 rounded p-2 transition-colors"><h4 class="text-sm font-medium text-gray-900 mb-1 line-clamp-2" x-text="article.headline"></h4><p class="text-xs text-gray-600" x-text="formatNewsTime(article.datetime)"></p><p class="text-xs text-gray-500 mt-1" x-text="article.source"></p></div></div>
                        </template>
                        <!-- ... -->
                    </div>
                </div>
            </div>
            <!-- ... 省略右侧边栏 ... -->
        </div>
    </main>

    <!-- *** 新增的新闻模态框 *** -->
    <div x-show="isModalOpen" class="modal-overlay flex items-center justify-center p-4" @click.self="isModalOpen = false" x-cloak x-transition>
        <div class="bg-white rounded-lg card-shadow w-full max-w-4xl flex flex-col" @click.stop>
            <div class="p-6 overflow-y-auto modal-content">
                <div x-show="articleLoading" class="animate-pulse"><div class="h-8 bg-gray-200 rounded w-3/4 mb-4"></div><div class="h-4 bg-gray-200 rounded w-full mb-2"></div><div class="h-4 bg-gray-200 rounded w-full mb-2"></div><div class="h-4 bg-gray-200 rounded w-5/6"></div></div>
                <div x-show="!articleLoading" class="prose max-w-none">
                    <h2 class="text-2xl font-bold mb-2" x-text="currentArticle.title"></h2>
                    <p class="text-sm text-gray-500 mb-4 italic" x-text="currentArticle.author || currentArticle.siteName"></p>
                    <div x-html="currentArticle.content"></div>
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-3 flex justify-end border-t"><button @click="isModalOpen = false" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Close</button></div>
        </div>
    </div>

    <script>
        function liveStockApp() {
            return {
                // ... state ...
                isModalOpen: false, articleLoading: false, currentArticle: { title: '', content: '' },
                quoteInterval: null, newsInterval: null,

                async init() {
                    // ...
                    await this.loadStock();
                },
                
                async loadStock() {
                    this.loading = true; this.error = null;
                    this.cleanup(); // 切换股票时，清除所有旧的定时器

                    try {
                        const [quoteData, profileData, metricsData, newsData] = await Promise.all([ /* ... */ ]);
                        this.quote = quoteData; this.companyProfile = profileData; this.metrics = metricsData; this.news = newsData;
                        this.loading = false;
                        this.$nextTick(() => { this.loadCandles(); });
                        this.startIntervals(); // 所有数据加载完后，再开始自动刷新
                    } catch (error) { /* ... */ } 
                },
                
                startIntervals() {
                    this.startQuoteRefresh();
                    this.startNewsRefresh();
                },
                
                startQuoteRefresh() {
                    this.quoteInterval = setInterval(async () => { /* ... 20秒刷新 ... */ }, 20000);
                },
                
                // *** 新闻自动刷新 (5分钟) ***
                startNewsRefresh() {
                    this.newsInterval = setInterval(async () => {
                        console.log("Refreshing news...");
                        await this.loadNews(true); // silent = true
                    }, 300000); // 5分钟 = 300,000毫秒
                },

                async loadNews(silent = false) {
                    if (!silent) this.loading = true;
                    try {
                        const newsUrl = `/api/stock/news?symbol=${this.symbol}&lang=${this.language}`;
                        this.news = await fetch(newsUrl).then(res => this.handleResponse(res));
                    } catch (e) { console.error("News load failed:", e); }
                    finally { if (!silent) this.loading = false; }
                },

                // *** K 线图时间轴调整 (50个数据点) ***
                async loadCandles() {
                    this.chartLoading = true;
                    try {
                        const to = Math.floor(Date.now() / 1000); let from;
                        const DAY = 86400; // 每天的秒数
                        switch (this.selectedPeriod) {
                            case 'W': from = to - (50 * 7 * DAY); break; // 50 周
                            case 'M': from = to - (50 * 30.44 * DAY); break; // 50 月 (约数)
                            default: from = to - (50 * DAY); // 50 天
                        }
                        const url = `/api/stock/candles?symbol=${this.symbol}&resolution=${this.selectedPeriod}&from=${from}&to=${to}`;
                        this.candles = await fetch(url).then(res => this.handleResponse(res));
                        this.updateChart();
                    } catch (error) { this.error = `[Chart Load Error] ${error.message}`; } 
                    finally { this.chartLoading = false; }
                },

                // *** 打开文章模态框 ***
                async openArticleModal(url) {
                    this.isModalOpen = true;
                    this.articleLoading = true;
                    this.currentArticle = { title: 'Loading...', content: '<p>Fetching and translating content...</p>' };
                    try {
                        const apiUrl = `/api/news/content?url=${encodeURIComponent(url)}&lang=${this.language}`;
                        this.currentArticle = await fetch(apiUrl).then(res => this.handleResponse(res));
                    } catch (error) {
                        this.currentArticle.title = 'Error';
                        this.currentArticle.content = `<p>Failed to load or translate the article: ${error.message}</p>`;
                    } finally { this.articleLoading = false; }
                },
                
                // 清理所有定时器，防止内存泄漏
                cleanup() {
                    clearInterval(this.quoteInterval);
                    clearInterval(this.newsInterval);
                },
                
                // ... 其他所有函数保持不变 ...
            }
        }
    </script>
</body>
</html>