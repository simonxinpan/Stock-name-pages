<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能个股详情页 - V5 Live</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .status-connecting { color: #f59e0b; }
        .status-connected { color: #10b981; }
        .status-disconnected { color: #ef4444; }
        [x-cloak] { display: none !important; }
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-50" x-data="liveStockApp()" x-init="init()">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-4">
                        <h1 class="text-xl font-bold text-gray-900">智能个股详情页</h1>
                        <span class="text-sm px-2 py-1 bg-blue-100 text-blue-800 rounded">V5 Live</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <!-- Language Toggle -->
                        <button @click="toggleLanguage()" 
                                class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded transition-colors">
                            <span x-text="language === 'zh' ? 'EN' : '中文'"></span>
                        </button>
                        <!-- Connection Status -->
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 rounded-full" :class="connectionStatus"></div>
                            <span class="text-sm text-gray-600" x-text="getConnectionText()"></span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Stock Symbol Input -->
            <div class="mb-8">
                <div class="flex items-center space-x-4">
                    <input type="text" 
                           x-model="symbol" 
                           @keyup.enter="loadStock()"
                           placeholder="输入股票代码 (如: AAPL, TSLA)"
                           class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <button @click="loadStock()" 
                            :disabled="loading"
                            class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                        <span x-show="!loading">查询</span>
                        <span x-show="loading">加载中...</span>
                    </button>
                </div>
            </div>

            <!-- Error Display -->
            <div x-show="error" x-cloak class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
                <div class="flex items-center">
                    <div class="text-red-600">
                        <span x-text="error"></span>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div x-show="loading" x-cloak class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <p class="mt-2 text-gray-600">正在加载股票数据...</p>
            </div>

            <!-- Stock Data -->
            <div x-show="!loading && quote" x-cloak class="space-y-8">
                <!-- Stock Quote Card -->
                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900" x-text="symbol.toUpperCase()"></h2>
                            <p class="text-gray-600" x-text="companyProfile?.name || 'Loading...'"></p>
                        </div>
                        <div class="text-right">
                            <div class="text-3xl font-bold" :class="quote?.dp >= 0 ? 'text-green-600' : 'text-red-600'">
                                $<span x-text="quote?.c?.toFixed(2) || '0.00'"></span>
                            </div>
                            <div class="flex items-center space-x-2" :class="quote?.dp >= 0 ? 'text-green-600' : 'text-red-600'">
                                <span x-text="(quote?.dp >= 0 ? '+' : '') + (quote?.d?.toFixed(2) || '0.00')"></span>
                                <span>(<span x-text="(quote?.dp >= 0 ? '+' : '') + (quote?.dp?.toFixed(2) || '0.00')"></span>%)</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stock Details Grid -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
                        <div class="text-center p-3 bg-gray-50 rounded">
                            <div class="text-sm text-gray-600" x-text="language === 'zh' ? '开盘价' : 'Open'"></div>
                            <div class="font-semibold">$<span x-text="quote?.o?.toFixed(2) || '0.00'"></span></div>
                        </div>
                        <div class="text-center p-3 bg-gray-50 rounded">
                            <div class="text-sm text-gray-600" x-text="language === 'zh' ? '最高价' : 'High'"></div>
                            <div class="font-semibold">$<span x-text="quote?.h?.toFixed(2) || '0.00'"></span></div>
                        </div>
                        <div class="text-center p-3 bg-gray-50 rounded">
                            <div class="text-sm text-gray-600" x-text="language === 'zh' ? '最低价' : 'Low'"></div>
                            <div class="font-semibold">$<span x-text="quote?.l?.toFixed(2) || '0.00'"></span></div>
                        </div>
                        <div class="text-center p-3 bg-gray-50 rounded">
                            <div class="text-sm text-gray-600" x-text="language === 'zh' ? '前收盘' : 'Prev Close'"></div>
                            <div class="font-semibold">$<span x-text="quote?.pc?.toFixed(2) || '0.00'"></span></div>
                        </div>
                    </div>
                </div>

                <!-- Company Profile -->
                <div x-show="companyProfile" class="bg-white rounded-lg shadow-sm border p-6">
                    <h3 class="text-lg font-semibold mb-4" x-text="language === 'zh' ? '公司信息' : 'Company Profile'"></h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <div class="space-y-3">
                                <div>
                                    <span class="text-sm text-gray-600" x-text="language === 'zh' ? '行业：' : 'Industry: '"></span>
                                    <span x-text="companyProfile?.finnhubIndustry || 'N/A'"></span>
                                </div>
                                <div>
                                    <span class="text-sm text-gray-600" x-text="language === 'zh' ? '国家：' : 'Country: '"></span>
                                    <span x-text="companyProfile?.country || 'N/A'"></span>
                                </div>
                                <div>
                                    <span class="text-sm text-gray-600" x-text="language === 'zh' ? '货币：' : 'Currency: '"></span>
                                    <span x-text="companyProfile?.currency || 'N/A'"></span>
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="space-y-3">
                                <div>
                                    <span class="text-sm text-gray-600" x-text="language === 'zh' ? '市值：' : 'Market Cap: '"></span>
                                    <span x-text="formatMarketCap(companyProfile?.marketCapitalization)"></span>
                                </div>
                                <div>
                                    <span class="text-sm text-gray-600" x-text="language === 'zh' ? '流通股：' : 'Shares Outstanding: '"></span>
                                    <span x-text="formatNumber(companyProfile?.shareOutstanding)"></span>
                                </div>
                                <div x-show="companyProfile?.weburl">
                                    <span class="text-sm text-gray-600" x-text="language === 'zh' ? '官网：' : 'Website: '"></span>
                                    <a :href="companyProfile?.weburl" target="_blank" class="text-blue-600 hover:underline" x-text="companyProfile?.weburl"></a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chart Section -->
                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold" x-text="language === 'zh' ? 'K线图' : 'Price Chart'"></h3>
                        <div class="flex space-x-2">
                            <template x-for="period in timePeriods" :key="period.value">
                                <button @click="changePeriod(period.value)"
                                        :class="selectedPeriod === period.value ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                        class="px-3 py-1 text-sm rounded transition-colors"
                                        x-text="language === 'zh' ? period.zh : period.en">
                                </button>
                            </template>
                        </div>
                    </div>
                    
                    <div x-show="chartLoading" class="text-center py-8">
                        <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                        <p class="mt-2 text-gray-600">正在加载图表数据...</p>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="stockChart"></canvas>
                    </div>
                </div>

                <!-- News Section -->
                <div x-show="news && news.length > 0" class="bg-white rounded-lg shadow-sm border p-6">
                    <h3 class="text-lg font-semibold mb-4" x-text="language === 'zh' ? '相关新闻' : 'Related News'"></h3>
                    <div class="space-y-4">
                        <template x-for="article in news.slice(0, 5)" :key="article.id">
                            <div class="border-b border-gray-200 pb-4 last:border-b-0">
                                <a :href="article.url" target="_blank" class="block hover:bg-gray-50 p-2 rounded transition-colors">
                                    <h4 class="font-medium text-gray-900 hover:text-blue-600" x-text="article.headline"></h4>
                                    <p class="text-sm text-gray-600 mt-1" x-text="article.summary?.substring(0, 150) + '...'"></p>
                                    <div class="flex justify-between items-center mt-2">
                                        <span class="text-xs text-gray-500" x-text="article.source"></span>
                                        <span class="text-xs text-gray-500" x-text="formatDate(article.datetime)"></span>
                                    </div>
                                </a>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        function liveStockApp() {
            return {
                language: 'zh',
                symbol: 'AAPL',
                loading: true,
                chartLoading: false,
                error: null,
                connectionStatus: 'status-connecting',
                quote: null,
                companyProfile: null,
                candles: null,
                news: [],
                selectedPeriod: 'D',
                timePeriods: [
                    { value: 'D', zh: '日线', en: 'Day' },
                    { value: 'W', zh: '周线', en: 'Week' },
                    { value: 'M', zh: '月线', en: 'Month' }
                ],
                chart: null,
                
                async init() {
                    const savedLanguage = localStorage.getItem('language');
                    if (savedLanguage) this.language = savedLanguage;
                    await this.loadStock();
                },
                
                toggleLanguage() {
                    this.language = this.language === 'zh' ? 'en' : 'zh';
                    localStorage.setItem('language', this.language);
                },
                
                getConnectionText() {
                    const texts = {
                        'status-connecting': this.language === 'zh' ? '连接中' : 'Connecting',
                        'status-connected': this.language === 'zh' ? '已连接' : 'Connected',
                        'status-disconnected': this.language === 'zh' ? '连接失败' : 'Disconnected'
                    };
                    return texts[this.connectionStatus] || '';
                },
                
                async loadStock() {
                    this.loading = true;
                    this.error = null;
                    this.connectionStatus = 'status-connecting';
                    const currentSymbol = this.symbol.toUpperCase();

                    try {
                        const [quoteData, profileData, newsData] = await Promise.all([
                            fetch(`/api/stock/quote?symbol=${currentSymbol}`).then(res => this.handleResponse(res)),
                            fetch(`/api/stock/profile?symbol=${currentSymbol}`).then(res => this.handleResponse(res)),
                            fetch(`/api/stock/news?symbol=${currentSymbol}`).then(res => this.handleResponse(res))
                        ]);

                        this.quote = quoteData;
                        this.companyProfile = profileData;
                        this.news = newsData;
                        this.connectionStatus = 'status-connected';
                        
                        await this.loadCandles();

                    } catch (error) {
                        console.error('Data Load Error:', error);
                        this.error = `[Data Load Error] ${error.message}`;
                        this.connectionStatus = 'status-disconnected';
                    } finally {
                        this.loading = false;
                    }
                },
                
                async changePeriod(newPeriod) {
                    if (this.selectedPeriod === newPeriod && this.chart) return;
                    this.selectedPeriod = newPeriod;
                    await this.loadCandles();
                },

                async loadCandles() {
                    this.chartLoading = true;
                    this.error = null;
                    const currentSymbol = this.symbol.toUpperCase();
                    const resolution = this.selectedPeriod;
                    const to = Math.floor(Date.now() / 1000);
                    let from;
                    switch (resolution) {
                        case 'D': from = to - (365 * 24 * 60 * 60); break;
                        case 'W': from = to - (5 * 365 * 24 * 60 * 60); break;
                        case 'M': from = to - (20 * 365 * 24 * 60 * 60); break;
                        default: from = to - (365 * 24 * 60 * 60);
                    }
                    
                    try {
                        const url = `/api/stock/candles?symbol=${currentSymbol}&resolution=${resolution}&from=${from}&to=${to}`;
                        const candlesData = await fetch(url).then(res => this.handleResponse(res));
                        
                        if (candlesData && (candlesData.s === 'ok' || candlesData.s === 'no_data')) {
                            this.candles = candlesData;
                        } else {
                            this.candles = { s: 'no_data', t: [], c: [] };
                            throw new Error(candlesData.error || 'Invalid candle data received');
                        }
                        this.updateChart();
                    } catch (error) {
                        console.error('Chart Load Error:', error);
                        this.error = `[Chart Load Error] ${error.message}`;
                        this.candles = { s: 'error' };
                        this.updateChart();
                    } finally {
                        this.chartLoading = false;
                    }
                },

                async handleResponse(response) {
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: `Request failed with status ${response.status}` }));
                        throw new Error(errorData.error);
                    }
                    return response.json();
                },
                
                updateChart() {
                    if (this.chart) this.chart.destroy();
                    const ctx = document.getElementById('stockChart');
                    
                    if (!ctx || !this.candles || (this.candles.s !== 'ok' && this.candles.s !== 'no_data') || !Array.isArray(this.candles.c)) {
                        console.warn("Aborting chart creation due to invalid data.", this.candles);
                        return;
                    }
                    
                    if (this.candles.c.length === 0) {
                        console.log("No data to display in chart.");
                        return;
                    }

                    const chartData = {
                        labels: this.candles.t.map(timestamp => {
                            const date = new Date(timestamp * 1000);
                            return date.toLocaleDateString();
                        }),
                        datasets: [{
                            label: this.language === 'zh' ? '收盘价' : 'Close Price',
                            data: this.candles.c,
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1
                        }]
                    };

                    this.chart = new Chart(ctx, {
                        type: 'line',
                        data: chartData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top'
                                }
                            },
                            scales: {
                                x: {
                                    display: true,
                                    title: {
                                        display: true,
                                        text: this.language === 'zh' ? '日期' : 'Date'
                                    }
                                },
                                y: {
                                    display: true,
                                    title: {
                                        display: true,
                                        text: this.language === 'zh' ? '价格 (USD)' : 'Price (USD)'
                                    }
                                }
                            },
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            }
                        }
                    });
                },
                
                // 修正后的市值计算函数
                formatMarketCap(capInMillions) {
                    if (!capInMillions) return 'N/A';
                    
                    if (this.language === 'zh') {
                        // 万亿美元 = trillion value
                        // 亿美元 = million value / 100 或 billion value * 10
                        if (capInMillions >= 1000000) {
                            return (capInMillions / 1000000).toFixed(2) + '万亿美元';
                        }
                        return (capInMillions / 100).toFixed(2) + '亿美元';
                    } else {
                        if (capInMillions >= 1000000) {
                            return '$' + (capInMillions / 1000000).toFixed(2) + 'T';
                        }
                        return '$' + (capInMillions / 1000).toFixed(2) + 'B';
                    }
                },
                
                formatNumber(num) {
                    if (!num) return 'N/A';
                    return new Intl.NumberFormat().format(num);
                },
                
                formatDate(timestamp) {
                    if (!timestamp) return '';
                    const date = new Date(timestamp * 1000);
                    return date.toLocaleDateString();
                }
            }
        }
    </script>
</body>
</html>