<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‚¡ç¥¨è¯¦æƒ…é¡µ - å®æ—¶ç¿»è¯‘ç‰ˆ</title>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100">
    <div x-data="liveStockApp()" x-init="init()" class="container mx-auto p-4">
        <!-- å¤´éƒ¨ä¿¡æ¯ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-3xl font-bold text-gray-800" x-text="getDisplayName()"></h1>
                <div class="text-right">
                    <div class="text-2xl font-bold" :class="quote?.c >= quote?.pc ? 'text-green-600' : 'text-red-600'" x-text="formatPrice(quote?.c)"></div>
                    <div class="text-sm" :class="quote?.c >= quote?.pc ? 'text-green-600' : 'text-red-600'" x-text="formatChange(quote?.d, quote?.dp)"></div>
                </div>
            </div>
            
            <!-- ç¿»è¯‘çŠ¶æ€æ˜¾ç¤º -->
            <div x-show="translating" class="text-blue-600 text-sm mb-2">
                ğŸ”„ æ­£åœ¨ç¿»è¯‘å…¬å¸åç§°...
            </div>
            
            <!-- å…¬å¸åŸºæœ¬ä¿¡æ¯ -->
            <div x-show="companyProfile" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div>
                    <span class="text-gray-600">è¡Œä¸š:</span>
                    <span x-text="companyProfile?.finnhubIndustry || 'N/A'"></span>
                </div>
                <div>
                    <span class="text-gray-600">å¸‚å€¼:</span>
                    <span x-text="formatMarketCap(companyProfile?.marketCapitalization)"></span>
                </div>
                <div>
                    <span class="text-gray-600">å‘˜å·¥æ•°:</span>
                    <span x-text="companyProfile?.employeeTotal || 'N/A'"></span>
                </div>
                <div>
                    <span class="text-gray-600">æˆç«‹:</span>
                    <span x-text="companyProfile?.ipo || 'N/A'"></span>
                </div>
            </div>
        </div>

        <!-- Kçº¿å›¾ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">ä»·æ ¼èµ°åŠ¿</h2>
            <canvas id="stockChart" width="400" height="200"></canvas>
        </div>

        <!-- åŠ è½½çŠ¶æ€ -->
        <div x-show="loading" class="text-center py-8">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <p class="mt-2 text-gray-600">åŠ è½½ä¸­...</p>
        </div>

        <!-- é”™è¯¯ä¿¡æ¯ -->
        <div x-show="error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
            <span x-text="error"></span>
        </div>
    </div>

    <script>
        function liveStockApp() {
            return {
                symbol: 'AAPL',
                chineseName: '',
                translating: false,
                companyProfile: null,
                quote: null,
                loading: false,
                error: null,
                chart: null,

                init() {
                    const urlParams = new URLSearchParams(window.location.search);
                    this.symbol = urlParams.get('symbol') || 'AAPL';
                    this.loadStock();
                },

                async loadStock() {
                    this.loading = true;
                    this.error = null;
                    this.chineseName = '';

                    try {
                        // å¹¶è¡ŒåŠ è½½åŸºç¡€æ•°æ®
                        const [quoteData, profileData] = await Promise.all([
                            this.fetchQuote(),
                            this.fetchProfile()
                        ]);

                        this.quote = quoteData;
                        this.companyProfile = profileData;
                        this.loading = false;

                        // å¼‚æ­¥ç¿»è¯‘å…¬å¸åç§°
                        if (this.companyProfile && this.companyProfile.name) {
                            this.translateCompanyName(this.companyProfile.name);
                        }

                        // åŠ è½½Kçº¿å›¾
                        this.loadCandles();

                    } catch (error) {
                        this.error = `åŠ è½½å¤±è´¥: ${error.message}`;
                        this.loading = false;
                        console.error('Load stock error:', error);
                    }
                },

                async fetchQuote() {
                    const response = await fetch(`/api/stock/quote?symbol=${this.symbol}`);
                    if (!response.ok) throw new Error('è·å–æŠ¥ä»·å¤±è´¥');
                    return await response.json();
                },

                async fetchProfile() {
                    const response = await fetch(`/api/stock/profile?symbol=${this.symbol}`);
                    if (!response.ok) throw new Error('è·å–å…¬å¸ä¿¡æ¯å¤±è´¥');
                    return await response.json();
                },

                async translateCompanyName(englishName) {
                    if (!englishName) return;
                    
                    this.translating = true;
                    console.log(`ğŸ”„ å¼€å§‹ç¿»è¯‘å…¬å¸åç§°: "${englishName}"`);

                    try {
                        const response = await fetch('/api/translate', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                text: englishName,
                                target_lang: 'zh'
                            })
                        });

                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(errorData.error || `ç¿»è¯‘APIå¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.status}`);
                        }

                        const data = await response.json();
                        this.chineseName = data.translated_text;
                        console.log(`âœ… ç¿»è¯‘æˆåŠŸ: "${englishName}" -> "${this.chineseName}"`);

                    } catch (error) {
                        console.error('âŒ ç¿»è¯‘å¤±è´¥:', error);
                        // ç¿»è¯‘å¤±è´¥æ—¶ä¿æŒè‹±æ–‡åç§°
                        this.chineseName = '';
                    } finally {
                        this.translating = false;
                    }
                },

                async loadCandles() {
                    try {
                        const response = await fetch(`/api/stock/candles?symbol=${this.symbol}&resolution=D&count=30`);
                        if (!response.ok) throw new Error('è·å–Kçº¿æ•°æ®å¤±è´¥');
                        const candleData = await response.json();
                        this.renderChart(candleData);
                    } catch (error) {
                        console.error('Load candles error:', error);
                    }
                },

                renderChart(candleData) {
                    const ctx = document.getElementById('stockChart').getContext('2d');
                    
                    if (this.chart) {
                        this.chart.destroy();
                    }

                    const labels = candleData.t?.map(timestamp => 
                        new Date(timestamp * 1000).toLocaleDateString()
                    ) || [];

                    this.chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'æ”¶ç›˜ä»·',
                                data: candleData.c || [],
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: false
                                }
                            }
                        }
                    });
                },

                getDisplayName() {
                    // ä¼˜å…ˆæ˜¾ç¤ºç¿»è¯‘åçš„ä¸­æ–‡åç§°
                    if (this.chineseName) {
                        return `${this.chineseName} (${this.symbol})`;
                    }
                    // å…¶æ¬¡æ˜¾ç¤ºè‹±æ–‡åç§°
                    if (this.companyProfile?.name) {
                        return `${this.companyProfile.name} (${this.symbol})`;
                    }
                    // æœ€åæ˜¾ç¤ºè‚¡ç¥¨ä»£ç 
                    return this.symbol;
                },

                formatPrice(price) {
                    return price ? `$${price.toFixed(2)}` : 'N/A';
                },

                formatChange(change, changePercent) {
                    if (!change || !changePercent) return 'N/A';
                    const sign = change >= 0 ? '+' : '';
                    return `${sign}${change.toFixed(2)} (${sign}${changePercent.toFixed(2)}%)`;
                },

                formatMarketCap(marketCap) {
                    if (!marketCap) return 'N/A';
                    if (marketCap >= 1000000) {
                        return `$${(marketCap / 1000000).toFixed(1)}T`;
                    } else if (marketCap >= 1000) {
                        return `$${(marketCap / 1000).toFixed(1)}B`;
                    }
                    return `$${marketCap.toFixed(1)}M`;
                }
            }
        }
    </script>
</body>
</html>