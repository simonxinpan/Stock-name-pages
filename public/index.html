<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能个股详情页 - Live</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .price-up-us { color: #10b981; } .price-down-us { color: #ef4444; } .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); } .loading { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; } @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } } [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-50" x-data="liveStockApp()" x-init="init()">
    
    <!-- ... HTML 结构部分 ... (和之前一样) -->
    
    <script>
        function liveStockApp() {
            return {
                language: 'zh',
                symbol: 'AAPL', loading: true, chartLoading: false, error: null,
                quote: null, companyProfile: null, candles: null, metrics: null,
                selectedPeriod: 'D',
                timePeriods: [ { value: 'D', zh: '日线', en: 'Day' }, { value: 'W', zh: '周线', en: 'Week' }, { value: 'M', zh: '月线', en: 'Month' } ],
                chart: null,
                
                async init() {
                    const savedLang = localStorage.getItem('stock-lang');
                    if (savedLang) this.language = savedLang;
                    await this.loadStock();
                },
                
                async loadStock() {
                    this.loading = true; this.error = null;
                    try {
                        const [quoteData, profileData, metricsData] = await Promise.all([
                            fetch(`/api/stock/quote?symbol=${this.symbol}`).then(res => this.handleResponse(res)),
                            fetch(`/api/stock/profile?symbol=${this.symbol}`).then(res => this.handleResponse(res)),
                            fetch(`/api/stock/metrics?symbol=${this.symbol}`).then(res => this.handleResponse(res))
                        ]);
                        this.quote = quoteData;
                        this.companyProfile = profileData;
                        this.metrics = metricsData;
                        // *** 关键时机：确保 quote 数据存在后，再加载图表 ***
                        await this.loadCandles();
                    } catch (error) { this.error = `[Data Load Error] ${error.message}`; } 
                    finally { this.loading = false; }
                },
                
                async changePeriod(newPeriod) { /* ... 和之前一样 ... */ },

                async loadCandles() {
                    this.chartLoading = true;
                    try {
                        const to = Math.floor(Date.now() / 1000); let from;
                        switch (this.selectedPeriod) {
                            case 'W': from = to - (5 * 365 * 24 * 60 * 60); break;
                            case 'M': from = to - (20 * 365 * 24 * 60 * 60); break;
                            default: from = to - (365 * 24 * 60 * 60);
                        }
                        const url = `/api/stock/candles?symbol=${this.symbol}&resolution=${this.selectedPeriod}&from=${from}&to=${to}`;
                        const candlesData = await fetch(url).then(res => this.handleResponse(res));
                        this.candles = candlesData;
                        this.updateChart(); // 在这里调用
                    } catch (error) { this.error = `[Chart Load Error] ${error.message}`; this.candles = { s: 'error' }; this.updateChart(); } 
                    finally { this.chartLoading = false; }
                },

                async handleResponse(response) { /* ... 和之前一样 ... */ },
                
                // *** 最终的、釜底抽薪的 updateChart 函数 ***
                updateChart() {
                    if (this.chart) this.chart.destroy();
                    const ctx = document.getElementById('stockChart');
                    
                    // 1. 最严格的数据检查
                    if (!ctx || !this.candles || !this.quote || (this.candles.s !== 'ok' && this.candles.s !== 'no_data') || !Array.isArray(this.candles.c)) {
                        console.warn("Aborting chart creation due to invalid/incomplete data.", { candles: this.candles, quote: this.quote });
                        return;
                    }
                    
                    const chartCtx = ctx.getContext('2d');
                    
                    // 2. 优雅地处理空数据情况
                    if (this.candles.c.length === 0) {
                        chartCtx.clearRect(0, 0, ctx.width, ctx.height);
                        chartCtx.textAlign = 'center';
                        chartCtx.fillStyle = '#9ca3af';
                        chartCtx.font = '16px sans-serif';
                        chartCtx.fillText(this.language === 'zh' ? '当前周期无可用数据' : 'No Chart Data Available', ctx.width / 2, ctx.height / 2);
                        return;
                    }

                    const isPositive = this.quote.d >= 0;
                    const color = isPositive ? '#10b981' : '#ef4444'; // 美股：涨绿跌红
                    const gradient = chartCtx.createLinearGradient(0, 0, 0, 400);
                    gradient.addColorStop(0, isPositive ? 'rgba(16, 185, 129, 0.3)' : 'rgba(239, 68, 68, 0.3)');
                    gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
                    
                    this.chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: this.candles.t.map(ts => new Date(ts * 1000).toLocaleDateString()),
                            datasets: [{ 
                                label: this.symbol, 
                                data: this.candles.c, 
                                borderColor: color, 
                                backgroundColor: gradient, 
                                borderWidth: 2, 
                                fill: true, 
                                tension: 0.1, 
                                pointRadius: 0 
                            }]
                        },
                        // 3. *** 彻底简化的配置，移除所有可能出错的插件 ***
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false // 禁用图例插件
                                },
                                tooltip: {
                                    enabled: false // 彻底禁用 tooltip 插件
                                }
                            },
                            scales: { 
                                x: { display: false }, 
                                y: { position: 'right', ticks: { color: color } } 
                            },
                            interaction: {
                                enabled: false // 禁用所有交互
                            },
                            animation: false // 禁用动画，加快渲染
                        }
                    });
                },
                
                // ... 省略其他所有未改动的工具函数，包括 formatMarketCap ...
            }
        }
    </script>
</body>
</html>