<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能个股详情页</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        .card-shadow { box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); z-index: 40; }
        .modal-content { max-height: 80vh; }
        .prose-styles h1, .prose-styles h2 { font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; }
        .prose-styles p { margin-bottom: 1em; line-height: 1.6; }
        .prose-styles a { color: #3b82f6; text-decoration: underline; }
    </style>
</head>
<body class="bg-gray-50" x-data="stockApp()" x-init="init()">
    <!-- 导航栏 -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-bold text-gray-900">智能个股详情页</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <input 
                        type="text" 
                        x-model="symbol" 
                        @keyup.enter="loadStock()"
                        placeholder="输入股票代码 (如: AAPL)"
                        class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                    <button 
                        @click="loadStock()" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        :disabled="loading"
                    >
                        <span x-show="!loading">搜索</span>
                        <span x-show="loading">加载中...</span>
                    </button>
                    <button 
                        @click="toggleLanguage()" 
                        class="px-3 py-2 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200"
                    >
                        <span x-text="language === 'zh' ? 'EN' : '中文'"></span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- 加载状态 -->
    <div x-show="loading" class="flex justify-center items-center h-64" x-cloak>
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
    </div>

    <!-- 主要内容 -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6" x-show="!loading && quote" x-cloak>
        <!-- 股票基本信息 -->
        <div class="bg-white rounded-lg card-shadow p-6 mb-6">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900">
                        <span x-text="profile?.name || symbol"></span>
                        <span x-show="language === 'zh' && getChineseStockName(symbol) !== symbol" class="text-xl text-gray-600 ml-2" x-text="'(' + getChineseStockName(symbol) + ')'"></span>
                    </h2>
                    <p class="text-sm text-gray-500" x-text="symbol"></p>
                </div>
                <div class="mt-4 sm:mt-0 text-right">
                    <div class="text-3xl font-bold" :class="quote?.dp >= 0 ? 'text-green-600' : 'text-red-600'" x-text="'$' + quote?.c?.toFixed(2)"></div>
                    <div class="text-sm" :class="quote?.dp >= 0 ? 'text-green-600' : 'text-red-600'">
                        <span x-text="(quote?.dp >= 0 ? '+' : '') + quote?.d?.toFixed(2)"></span>
                        <span x-text="'(' + (quote?.dp >= 0 ? '+' : '') + quote?.dp?.toFixed(2) + '%)'" class="ml-1"></span>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- 左侧：K线图 -->
            <div class="lg:col-span-2 space-y-6">
                <!-- K线图 -->
                <div class="bg-white rounded-lg card-shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900" x-text="language === 'zh' ? 'K线图' : 'Chart'"></h3>
                        <div class="flex space-x-2">
                            <template x-for="period in periods" :key="period.value">
                                <button 
                                    @click="changePeriod(period.value)"
                                    :class="selectedPeriod === period.value ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                    class="px-3 py-1 text-sm rounded-md"
                                    x-text="period.label"
                                ></button>
                            </template>
                        </div>
                    </div>
                    <div class="h-96">
                        <canvas id="stockChart" class="w-full h-full"></canvas>
                    </div>
                </div>

                <!-- 相关新闻 -->
                <div class="bg-white rounded-lg card-shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4" x-text="language === 'zh' ? '相关新闻' : 'Related News'"></h3>
                    <div class="max-h-96 overflow-y-auto space-y-3">
                        <template x-for="article in news.slice(0, 10)" :key="article.id">
                            <div @click="openArticleModal(article.url)" class="cursor-pointer border-b border-gray-100 pb-3 last:border-b-0">
                                <div class="block hover:bg-gray-50 rounded p-2 transition-colors">
                                    <h4 class="text-sm font-medium text-gray-900 mb-1 line-clamp-2" x-text="article.headline"></h4>
                                    <p class="text-xs text-gray-600" x-text="formatNewsTime(article.datetime)"></p>
                                    <p class="text-xs text-gray-500 mt-1" x-text="article.source"></p>
                                </div>
                            </div>
                        </template>
                        <div x-show="news.length === 0" class="text-center text-gray-500 py-4">
                            <span x-text="language === 'zh' ? '暂无新闻' : 'No news available'"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧：股票信息 -->
            <div class="space-y-6">
                <!-- 关键指标 -->
                <div class="bg-white rounded-lg card-shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4" x-text="language === 'zh' ? '关键指标' : 'Key Metrics'"></h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600" x-text="language === 'zh' ? '开盘价' : 'Open'"></span>
                            <span class="text-sm font-medium" x-text="'$' + quote?.o?.toFixed(2)"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600" x-text="language === 'zh' ? '最高价' : 'High'"></span>
                            <span class="text-sm font-medium" x-text="'$' + quote?.h?.toFixed(2)"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600" x-text="language === 'zh' ? '最低价' : 'Low'"></span>
                            <span class="text-sm font-medium" x-text="'$' + quote?.l?.toFixed(2)"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600" x-text="language === 'zh' ? '前收盘' : 'Prev Close'"></span>
                            <span class="text-sm font-medium" x-text="'$' + quote?.pc?.toFixed(2)"></span>
                        </div>
                        <div class="flex justify-between" x-show="metrics">
                            <span class="text-sm text-gray-600" x-text="language === 'zh' ? '52周最高' : '52W High'"></span>
                            <span class="text-sm font-medium" x-text="'$' + formatMetric(metrics?.['52WeekHigh'])"></span>
                        </div>
                        <div class="flex justify-between" x-show="metrics">
                            <span class="text-sm text-gray-600" x-text="language === 'zh' ? '52周最低' : '52W Low'"></span>
                            <span class="text-sm font-medium" x-text="'$' + formatMetric(metrics?.['52WeekLow'])"></span>
                        </div>
                    </div>
                </div>

                <!-- 财务指标 -->
                <div class="bg-white rounded-lg card-shadow p-6" x-show="metrics || profile">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4" x-text="language === 'zh' ? '财务指标' : 'Financial Metrics'"></h3>
                    <div class="space-y-3">
                        <div class="flex justify-between" x-show="profile?.marketCapitalization">
                            <span class="text-sm text-gray-600" x-text="language === 'zh' ? '市值' : 'Market Cap'"></span>
                            <span class="text-sm font-medium" x-text="formatMarketCap(profile?.marketCapitalization)"></span>
                        </div>
                        <div class="flex justify-between" x-show="metrics?.peBasicExclExtraTTM">
                            <span class="text-sm text-gray-600" x-text="language === 'zh' ? '市盈率(TTM)' : 'P/E Ratio (TTM)'"></span>
                            <span class="text-sm font-medium" x-text="formatMetric(metrics?.peBasicExclExtraTTM)"></span>
                        </div>
                        <div class="flex justify-between" x-show="metrics?.epsBasicExclExtraAnnual">
                            <span class="text-sm text-gray-600" x-text="language === 'zh' ? '每股收益' : 'EPS'"></span>
                            <span class="text-sm font-medium" x-text="'$' + formatMetric(metrics?.epsBasicExclExtraAnnual)"></span>
                        </div>
                        <div class="flex justify-between" x-show="metrics?.dividendYieldIndicatedAnnual">
                            <span class="text-sm text-gray-600" x-text="language === 'zh' ? '股息收益率' : 'Dividend Yield'"></span>
                            <span class="text-sm font-medium" x-text="formatPercentage(metrics?.dividendYieldIndicatedAnnual)"></span>
                        </div>
                        <div class="flex justify-between" x-show="metrics?.beta">
                            <span class="text-sm text-gray-600" x-text="language === 'zh' ? 'Beta系数' : 'Beta'"></span>
                            <span class="text-sm font-medium" x-text="formatMetric(metrics?.beta)"></span>
                        </div>
                        <div class="flex justify-between" x-show="metrics?.pbAnnual">
                            <span class="text-sm text-gray-600" x-text="language === 'zh' ? '市净率' : 'P/B Ratio'"></span>
                            <span class="text-sm font-medium" x-text="formatMetric(metrics?.pbAnnual)"></span>
                        </div>
                        <div class="flex justify-between" x-show="metrics?.roeTTM">
                            <span class="text-sm text-gray-600" x-text="language === 'zh' ? 'ROE' : 'ROE'"></span>
                            <span class="text-sm font-medium" x-text="formatPercentage(metrics?.roeTTM)"></span>
                        </div>
                    </div>
                </div>

                <!-- 公司信息 -->
                <div class="bg-white rounded-lg card-shadow p-6" x-show="profile">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4" x-text="language === 'zh' ? '公司信息' : 'Company Info'"></h3>
                    <div class="space-y-3">
                        <div>
                            <span class="text-sm text-gray-600" x-text="language === 'zh' ? '行业' : 'Industry'"></span>
                            <p class="text-sm font-medium" x-text="profile?.finnhubIndustry || 'N/A'"></p>
                        </div>
                        <div>
                            <span class="text-sm text-gray-600" x-text="language === 'zh' ? '国家' : 'Country'"></span>
                            <p class="text-sm font-medium" x-text="profile?.country || 'N/A'"></p>
                        </div>
                        <div x-show="profile?.weburl">
                            <span class="text-sm text-gray-600" x-text="language === 'zh' ? '官网' : 'Website'"></span>
                            <a :href="profile?.weburl" target="_blank" class="text-sm font-medium text-blue-600 hover:underline block" x-text="profile?.weburl"></a>
                        </div>
                    </div>
                </div>

                <!-- 相关链接 -->
                <div class="bg-white rounded-lg card-shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4" x-text="language === 'zh' ? '相关链接' : 'Related Links'"></h3>
                    <div class="space-y-3">
                        <button 
                            @click="openYouTubeSearch()"
                            class="w-full px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 text-sm"
                        >
                            <span x-text="language === 'zh' ? 'YouTube 分析视频' : 'YouTube Analysis'"></span>
                        </button>
                        <button 
                            @click="openXueqiuSearch()"
                            class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm"
                        >
                            <span x-text="language === 'zh' ? '雪球社区讨论' : 'Xueqiu Discussion'"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 新闻模态框 -->
    <div x-show="isModalOpen" class="modal-overlay flex items-center justify-center" @click.self="isModalOpen = false" x-cloak>
        <div class="bg-white rounded-lg card-shadow w-11/12 md:w-3/4 lg:w-1/2" @click.stop>
            <div class="p-6">
                <div x-show="articleLoading" class="animate-pulse">
                    <div class="h-8 bg-gray-200 rounded w-3/4 mb-4"></div>
                    <div class="h-4 bg-gray-200 rounded w-full mb-2"></div>
                    <div class="h-4 bg-gray-200 rounded w-full mb-2"></div>
                    <div class="h-4 bg-gray-200 rounded w-5/6"></div>
                </div>
                <div x-show="!articleLoading">
                    <h2 class="text-2xl font-bold mb-2" x-text="currentArticle.title"></h2>
                    <p class="text-sm text-gray-500 mb-4" x-text="currentArticle.author || currentArticle.siteName"></p>
                    <div class="modal-content overflow-y-auto prose-styles" x-html="currentArticle.content"></div>
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-3 flex justify-end">
                <button @click="isModalOpen = false" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">
                    <span x-text="language === 'zh' ? '关闭' : 'Close'"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- 错误提示 -->
    <div x-show="error" class="fixed bottom-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded" x-cloak>
        <span x-text="error"></span>
        <button @click="error = ''" class="ml-2 text-red-500 hover:text-red-700">&times;</button>
    </div>

    <script>
        function stockApp() {
            return {
                // 状态变量
                symbol: 'AAPL',
                loading: false,
                error: '',
                language: 'zh',
                quote: null,
                profile: null,
                metrics: null,
                news: [],
                candles: null,
                chart: null,
                selectedPeriod: 'D',
                isModalOpen: false,
                articleLoading: false,
                currentArticle: { title: '', content: '' },
                lastCandleRequest: 0, // 记录上次K线请求时间
                candleRequestDelay: 20000, // 20秒间隔，避免Polygon API频率限制
                lastRequestParams: null, // 记录上次请求参数，避免重复请求
                
                // 时间周期选项
                periods: [
                    { value: '1', label: '1分钟' },
                    { value: '5', label: '5分钟' },
                    { value: '15', label: '15分钟' },
                    { value: 'D', label: '日线' },
                    { value: 'W', label: '周线' },
                    { value: 'M', label: '月线' }
                ],

                // 初始化
                async init() {
                    await this.loadStock();
                },

                // 加载股票数据
                async loadStock() {
                    if (!this.symbol) return;
                    
                    this.loading = true;
                    this.error = '';
                    
                    try {
                        // 并行加载数据
                        const [quoteRes, profileRes, metricsRes, newsRes] = await Promise.all([
                            fetch(`/api/stock/${this.symbol}?type=quote`),
                            fetch(`/api/stock/${this.symbol}?type=profile`),
                            fetch(`/api/stock/${this.symbol}?type=metrics`),
                            fetch(`/api/stock/news?symbol=${this.symbol}`)
                        ]);
                        
                        this.quote = await this.handleResponse(quoteRes);
                        this.profile = await this.handleResponse(profileRes);
                        this.metrics = await this.handleResponse(metricsRes);
                        this.news = await this.handleResponse(newsRes) || [];
                        
                        // 如果是中文模式，为每条新闻添加翻译标记
                        if (this.language === 'zh') {
                            this.news = this.news.map(item => ({
                                ...item,
                                needsTranslation: true,
                                translatedSummary: null
                            }));
                        }
                        
                        // 加载K线数据
                        await this.loadCandles();
                        
                    } catch (error) {
                        this.error = `加载失败: ${error.message}`;
                        console.error('Load stock error:', error);
                    } finally {
                        this.loading = false;
                    }
                },

                // 加载K线数据
                async loadCandles() {
                    try {
                        const to = Math.floor(Date.now() / 1000);
                        const from = to - (30 * 24 * 60 * 60); // 30天前
                        const requestParams = `${this.symbol}-${this.selectedPeriod}-${from}-${to}`;
                        
                        // 检查是否是重复请求
                        if (this.lastRequestParams === requestParams) {
                            console.log('重复的K线请求，跳过');
                            return;
                        }
                        
                        // 检查请求频率限制
                        const now = Date.now();
                        if (now - this.lastCandleRequest < this.candleRequestDelay) {
                            const remainingTime = Math.ceil((this.candleRequestDelay - (now - this.lastCandleRequest)) / 1000);
                            console.log(`K线请求过于频繁，需等待 ${remainingTime} 秒`);
                            return;
                        }
                        
                        this.lastCandleRequest = now;
                        this.lastRequestParams = requestParams;
                        
                        const response = await fetch(`/api/stock/candles?symbol=${this.symbol}&resolution=${this.selectedPeriod}&from=${from}&to=${to}`);
                        const data = await this.handleResponse(response);
                        
                        if (data && data.c && data.c.length > 0) {
                            // 处理时间戳，确保正确的日期格式
                            const timestamps = data.t.map(timestamp => {
                                // 如果时间戳是秒，转换为毫秒
                                const ts = timestamp.toString().length === 10 ? timestamp * 1000 : timestamp;
                                return new Date(ts).toLocaleDateString();
                            });
                            
                            this.candles = {
                                t: data.t,
                                c: data.c,
                                o: data.o,
                                h: data.h,
                                l: data.l,
                                v: data.v
                            };
                            
                            this.updateChart();
                        } else {
                            console.warn('No candle data received or invalid format');
                            // 创建模拟数据用于演示
                            this.createMockCandleData();
                        }
                    } catch (error) {
                        console.error('Load candles error:', error);
                        // 创建模拟数据用于演示
                        this.createMockCandleData();
                    }
                },

                // 切换时间周期
                async changePeriod(period) {
                    this.selectedPeriod = period;
                    // 重置请求参数，允许立即切换周期，但保持频率限制
                    this.lastRequestParams = null;
                    await this.loadCandles();
                },

                // 更新图表
                updateChart() {
                    const ctx = document.getElementById('stockChart');
                    if (!ctx) {
                        console.error('Chart canvas not found');
                        return;
                    }
                    
                    const canvas = ctx.getContext('2d');
                    if (!canvas) {
                        console.error('Cannot get canvas context');
                        return;
                    }
                    
                    // 销毁现有图表
                    if (this.chart) {
                        try {
                            this.chart.destroy();
                        } catch (e) {
                            console.warn('Error destroying chart:', e);
                        }
                        this.chart = null;
                    }
                    
                    try {
                        if (!this.candles || !this.candles.c || this.candles.c.length === 0) {
                            console.warn('No candle data available for chart');
                            // 显示无数据信息
                            canvas.clearRect(0, 0, ctx.width, ctx.height);
                            canvas.fillStyle = '#666';
                            canvas.font = '16px Arial';
                            canvas.textAlign = 'center';
                            canvas.fillText(
                                this.language === 'zh' ? '暂无图表数据' : 'No chart data available',
                                ctx.width / 2,
                                ctx.height / 2
                            );
                            return;
                        }
                        
                        // 准备图表数据
                        const labels = this.candles.t.map(timestamp => {
                            const date = new Date(timestamp * 1000);
                            return date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
                        });
                        
                        // 计算价格变化颜色
                        const priceColors = this.candles.c.map((close, index) => {
                            if (index === 0) return 'rgb(59, 130, 246)';
                            return close >= this.candles.c[index - 1] ? 'rgb(34, 197, 94)' : 'rgb(239, 68, 68)';
                        });
                        
                        // 根据时间周期创建不同的数据集
                        const datasets = [];
                        
                        // 主要收盘价线
                        datasets.push({
                            label: this.language === 'zh' ? '收盘价' : 'Close Price',
                            data: this.candles.c,
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1,
                            pointBackgroundColor: priceColors,
                            pointBorderColor: priceColors,
                            pointRadius: 3,
                            pointHoverRadius: 6
                        });
                        
                        // 添加开盘价线（稍微错开）
                        if (this.candles.o && this.candles.o.length > 0) {
                            datasets.push({
                                label: this.language === 'zh' ? '开盘价' : 'Open Price',
                                data: this.candles.o,
                                borderColor: 'rgb(34, 197, 94)',
                                backgroundColor: 'rgba(34, 197, 94, 0.05)',
                                borderWidth: 1.5,
                                fill: false,
                                tension: 0.1,
                                pointRadius: 2,
                                pointHoverRadius: 5,
                                borderDash: [5, 5]
                            });
                        }
                        
                        // 添加最高价线
                        if (this.candles.h && this.candles.h.length > 0) {
                            datasets.push({
                                label: this.language === 'zh' ? '最高价' : 'High Price',
                                data: this.candles.h,
                                borderColor: 'rgb(239, 68, 68)',
                                backgroundColor: 'rgba(239, 68, 68, 0.05)',
                                borderWidth: 1,
                                fill: false,
                                tension: 0.1,
                                pointRadius: 1,
                                pointHoverRadius: 4,
                                borderDash: [2, 3]
                            });
                        }
                        
                        // 添加最低价线
                        if (this.candles.l && this.candles.l.length > 0) {
                            datasets.push({
                                label: this.language === 'zh' ? '最低价' : 'Low Price',
                                data: this.candles.l,
                                borderColor: 'rgb(168, 85, 247)',
                                backgroundColor: 'rgba(168, 85, 247, 0.05)',
                                borderWidth: 1,
                                fill: false,
                                tension: 0.1,
                                pointRadius: 1,
                                pointHoverRadius: 4,
                                borderDash: [3, 2]
                            });
                        }
                        
                        this.chart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: datasets
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    intersect: false,
                                    mode: 'index'
                                },
                                plugins: {
                                    legend: {
                                        display: true,
                                        position: 'top',
                                        labels: {
                                            usePointStyle: true,
                                            padding: 20
                                        }
                                    },
                                    tooltip: {
                                        mode: 'index',
                                        intersect: false,
                                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                        titleColor: 'white',
                                        bodyColor: 'white',
                                        borderColor: 'rgba(59, 130, 246, 0.5)',
                                        borderWidth: 1,
                                        callbacks: {
                                            title: function(context) {
                                                if (!context || !context[0]) return '';
                                                return context[0].label;
                                            },
                                            label: function(context) {
                                                if (!context || !context.chart) return '';
                                                const index = context.dataIndex;
                                                const chart = context.chart;
                                                const opens = chart.config._config?.data?.opens;
                                                const highs = chart.config._config?.data?.highs;
                                                const lows = chart.config._config?.data?.lows;
                                                const volumes = chart.config._config?.data?.volumes;
                                                const close = context.parsed.y;
                                                
                                                const labels = [];
                                                if (opens && opens[index] !== undefined) labels.push(`开盘: $${opens[index].toFixed(2)}`);
                                                if (highs && highs[index] !== undefined) labels.push(`最高: $${highs[index].toFixed(2)}`);
                                                if (lows && lows[index] !== undefined) labels.push(`最低: $${lows[index].toFixed(2)}`);
                                                if (close !== undefined) labels.push(`收盘: $${close.toFixed(2)}`);
                                                if (volumes && volumes[index] !== undefined) labels.push(`成交量: ${(volumes[index] / 1000000).toFixed(2)}M`);
                                                
                                                return labels;
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    x: {
                                        display: true,
                                        grid: {
                                            display: true,
                                            color: 'rgba(0, 0, 0, 0.1)',
                                            drawBorder: false
                                        },
                                        ticks: {
                                            maxTicksLimit: 8,
                                            color: 'rgba(0, 0, 0, 0.6)'
                                        }
                                    },
                                    y: {
                                        display: true,
                                        position: 'right',
                                        grid: {
                                            display: true,
                                            color: 'rgba(0, 0, 0, 0.1)',
                                            drawBorder: false
                                        },
                                        ticks: {
                                            color: 'rgba(0, 0, 0, 0.6)',
                                            callback: function(value) {
                                                return '$' + value.toFixed(2);
                                            }
                                        }
                                    }
                                },
                                elements: {
                                    point: {
                                        hoverRadius: 8
                                    }
                                }
                            }
                        });
                        
                        // 存储额外数据用于tooltip
                        if (this.chart && this.candles) {
                            if (!this.chart.config._config) {
                                this.chart.config._config = { data: {} };
                            }
                            if (!this.chart.config._config.data) {
                                this.chart.config._config.data = {};
                            }
                            this.chart.config._config.data.opens = this.candles.o;
                            this.chart.config._config.data.highs = this.candles.h;
                            this.chart.config._config.data.lows = this.candles.l;
                            this.chart.config._config.data.volumes = this.candles.v;
                        }
                        
                    } catch (error) {
                        console.error('Chart creation error:', error);
                        // 显示错误信息
                        canvas.clearRect(0, 0, ctx.width, ctx.height);
                        canvas.fillStyle = '#666';
                        canvas.font = '16px Arial';
                        canvas.textAlign = 'center';
                        canvas.fillText(
                            this.language === 'zh' ? '图表加载失败' : 'Chart loading failed',
                            ctx.width / 2,
                            ctx.height / 2
                        );
                    }
                },

                // 打开文章模态框
                async openArticleModal(url) {
                    this.isModalOpen = true;
                    this.articleLoading = true;
                    this.currentArticle = { 
                        title: this.language === 'zh' ? '加载中...' : 'Loading...', 
                        content: this.language === 'zh' ? '<p>正在获取并翻译内容...</p>' : '<p>Fetching and translating content...</p>' 
                    };

                    try {
                        const lang = this.language === 'zh' ? 'zh' : 'en';
                        const apiUrl = `/api/news/content?url=${encodeURIComponent(url)}&lang=${lang}`;
                        const articleData = await fetch(apiUrl).then(res => this.handleResponse(res));
                        this.currentArticle = articleData;
                    } catch (error) {
                        this.currentArticle.title = this.language === 'zh' ? '加载失败' : 'Error';
                        this.currentArticle.content = this.language === 'zh' ? 
                            `<p>无法加载或翻译文章内容: ${error.message}</p>` : 
                            `<p>Failed to load or translate the article: ${error.message}</p>`;
                    } finally {
                        this.articleLoading = false;
                    }
                },

                // 打开YouTube搜索
                openYouTubeSearch() {
                    let query;
                    if (this.language === 'zh') {
                        // 中文模式：使用中文股票名+股票
                        const chineseName = this.getChineseStockName(this.symbol);
                        query = `${chineseName}股票`;
                    } else {
                        // 英文模式：使用原有逻辑
                        query = `${this.symbol} ${this.profile?.name || ''} stock analysis`;
                    }
                    const url = `https://www.youtube.com/results?search_query=${encodeURIComponent(query)}`;
                    window.open(url, '_blank');
                },
                
                // 获取中文股票名
                getChineseStockName(symbol) {
                    const chineseNames = {
                        'AAPL': '苹果',
                        'GOOGL': '谷歌',
                        'MSFT': '微软',
                        'AMZN': '亚马逊',
                        'TSLA': '特斯拉',
                        'META': 'Meta',
                        'NVDA': '英伟达',
                        'NFLX': '奈飞',
                        'BABA': '阿里巴巴',
                        'JD': '京东',
                        'PDD': '拼多多',
                        'BIDU': '百度',
                        'NIO': '蔚来',
                        'XPEV': '小鹏汽车',
                        'LI': '理想汽车',
                        'TME': '腾讯音乐',
                        'BILI': '哔哩哔哩'
                    };
                    return chineseNames[symbol] || symbol;
                },

                // 打开雪球搜索
                openXueqiuSearch() {
                    const url = `https://xueqiu.com/S/${this.symbol}`;
                    window.open(url, '_blank');
                },

                // 切换语言
                toggleLanguage() {
                    this.language = this.language === 'zh' ? 'en' : 'zh';
                    // 更新时间周期标签
                    if (this.language === 'zh') {
                        this.periods = [
                            { value: '1', label: '1分钟' },
                            { value: '5', label: '5分钟' },
                            { value: '15', label: '15分钟' },
                            { value: 'D', label: '日线' },
                            { value: 'W', label: '周线' },
                            { value: 'M', label: '月线' }
                        ];
                    } else {
                        this.periods = [
                            { value: '1', label: '1min' },
                            { value: '5', label: '5min' },
                            { value: '15', label: '15min' },
                            { value: 'D', label: 'Daily' },
                            { value: 'W', label: 'Weekly' },
                            { value: 'M', label: 'Monthly' }
                        ];
                    }
                },

                // 格式化市值
                formatMarketCap(marketCap) {
                    if (!marketCap) return 'N/A';
                    
                    // 先除以1000进行单位转换
                    const adjustedMarketCap = marketCap / 1000;
                    
                    if (this.language === 'zh') {
                        if (adjustedMarketCap >= 1) {
                            return `${adjustedMarketCap.toFixed(3)}万亿美元`;
                        } else {
                            return `${(adjustedMarketCap * 10000).toFixed(0)}亿美元`;
                        }
                    } else {
                        return `$${adjustedMarketCap.toFixed(3)}T`;
                    }
                },

                // 格式化新闻时间
                formatNewsTime(timestamp) {
                    const date = new Date(timestamp * 1000);
                    const now = new Date();
                    const diff = now - date;
                    const hours = Math.floor(diff / (1000 * 60 * 60));
                    const days = Math.floor(hours / 24);
                    
                    if (this.language === 'zh') {
                        if (hours < 1) return '刚刚';
                        if (hours < 24) return `${hours}小时前`;
                        if (days < 7) return `${days}天前`;
                        return date.toLocaleDateString('zh-CN');
                    } else {
                        if (hours < 1) return 'Just now';
                        if (hours < 24) return `${hours}h ago`;
                        if (days < 7) return `${days}d ago`;
                        return date.toLocaleDateString('en-US');
                    }
                },

                // 格式化财务指标
                formatMetric(value) {
                    if (value === null || value === undefined || isNaN(value)) return 'N/A';
                    
                    const numValue = parseFloat(value);
                    
                    // 处理大数值格式化
                    if (Math.abs(numValue) >= 1e12) {
                        // 1 trillion = 1万亿
                        return `${(numValue / 1e12).toFixed(2)}${this.language === 'zh' ? '万亿' : 'T'}`;
                    } else if (Math.abs(numValue) >= 1e9) {
                        // 1 billion = 10亿
                        return `${(numValue / 1e9).toFixed(2)}${this.language === 'zh' ? '十亿' : 'B'}`;
                    } else if (Math.abs(numValue) >= 1e8) {
                        // 1亿
                        return `${(numValue / 1e8).toFixed(2)}${this.language === 'zh' ? '亿' : '00M'}`;
                    } else if (Math.abs(numValue) >= 1e6) {
                        return `${(numValue / 1e6).toFixed(2)}${this.language === 'zh' ? '百万' : 'M'}`;
                    } else if (Math.abs(numValue) >= 1e3) {
                        return `${(numValue / 1e3).toFixed(2)}${this.language === 'zh' ? '千' : 'K'}`;
                    }
                    
                    return numValue.toFixed(2);
                },

                // 格式化百分比
                formatPercentage(value) {
                    if (value === null || value === undefined || isNaN(value)) return 'N/A';
                    // 数据已经是百分比形式，直接除以100显示
                    return (parseFloat(value) / 100).toFixed(2) + '%';
                },

                // 创建模拟K线数据
                createMockCandleData() {
                    // 创建30天的模拟K线数据
                    const days = 30;
                    const basePrice = this.quote?.c || 150; // 使用当前价格或默认值
                    const timestamps = [];
                    const closes = [];
                    const opens = [];
                    const highs = [];
                    const lows = [];
                    const volumes = [];
                    
                    let currentPrice = basePrice;
                    const now = new Date();
                    
                    for (let i = days - 1; i >= 0; i--) {
                        const date = new Date(now);
                        date.setDate(date.getDate() - i);
                        const timestamp = Math.floor(date.getTime() / 1000);
                        timestamps.push(timestamp);
                        
                        // 模拟价格波动
                        const change = (Math.random() - 0.5) * 0.1; // ±5%的随机变化
                        const open = currentPrice;
                        const close = currentPrice * (1 + change);
                        const high = Math.max(open, close) * (1 + Math.random() * 0.02);
                        const low = Math.min(open, close) * (1 - Math.random() * 0.02);
                        const volume = Math.floor(Math.random() * 1000000) + 500000;
                        
                        opens.push(parseFloat(open.toFixed(2)));
                        closes.push(parseFloat(close.toFixed(2)));
                        highs.push(parseFloat(high.toFixed(2)));
                        lows.push(parseFloat(low.toFixed(2)));
                        volumes.push(volume);
                        
                        currentPrice = close;
                    }
                    
                    this.candles = {
                        t: timestamps,
                        c: closes,
                        o: opens,
                        h: highs,
                        l: lows,
                        v: volumes
                    };
                    
                    this.updateChart();
                },

                // 处理API响应
                async handleResponse(response) {
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error || `HTTP ${response.status}`);
                    }
                    return await response.json();
                }
            }
        }
    </script>
</body>
</html>