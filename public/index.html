<!DOCTYPE html>
<html lang="zh-CN">
<!-- ... 省略 <head> 和 <body> ... -->
<script>
    function liveStockApp() {
        return {
            symbol: 'AAPL',
            chineseName: '', // ** 我们继续使用这个变量来存储翻译结果 **
            companyProfile: null,
            // ...

            async loadStock() {
                this.loading = true; this.error = null; this.chineseName = '';
                this.cleanup();

                try {
                    // **第一步：只加载 Finnhub 和 Polygon 的核心数据**
                    // 我们不再需要并行调用 get-chinese-name 了
                    const [quoteData, profileData, metricsData] = await Promise.all([ /* ... */ ]);
                    this.quote = quoteData;
                    this.companyProfile = profileData;
                    this.metrics = metricsData;
                    
                    this.loading = false;
                    
                    // **第二步：在核心数据加载后，独立进行翻译**
                    this.$nextTick(async () => {
                        this.loadCandles();
                        this.loadNews();
                        // *** 核心改动：在这里调用翻译 ***
                        if (this.companyProfile && this.companyProfile.name) {
                            this.chineseName = await this.translateText(this.companyProfile.name);
                        }
                    });

                    this.startIntervals();
                } catch (error) { this.error = `[Core Data Error] ${error.message}`; this.loading = false; }
            },

            // *** 新增的、专门用于翻译的函数 ***
            async translateText(textToTranslate) {
                if (!textToTranslate) return '';
                try {
                    console.log(`Requesting translation for: "${textToTranslate}"`);
                    const response = await fetch('/api/translate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: textToTranslate, target_lang: 'zh' })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error || `Translation API failed with status ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log(`Translation successful: "${data.translated_text}"`);
                    return data.translated_text;
                } catch (error) {
                    console.error("Translation failed:", error);

                    return textToTranslate; // 翻译失败则返回原文
                }
            },
            
            // *** 修改 getDisplayName 函数以使用翻译结果 ***
            getDisplayName() {
                // 如果是中文模式，并且我们成功获取了翻译，就用它
                if (this.language === 'zh' && this.chineseName) {
                    return this.chineseName;
                }
                // 否则，显示英文原名
                return this.companyProfile?.name || this.symbol;
            },

            // *** 修改 YouTube 搜索 ***
            getSearchTermForYoutube() {
                const name = this.chineseName || this.companyProfile?.name || this.symbol;
                return encodeURIComponent(name + ' 股票');
            },

            // ... 其他所有函数 (loadCandles, news, updateChart, format*, etc.) ...
        }
    }
</script>
</body>
</html>