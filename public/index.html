<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能个股详情页 - Live</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ... 省略所有 CSS 样式，和之前一样 ... */
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-50" x-data="liveStockApp()" x-init="init()">
    <!-- ... 省略所有 HTML 结构，和之前一样 ... -->
    
    <script>
        function liveStockApp() {
            return {
                language: 'zh',
                symbol: 'AAPL',
                loading: true,
                chartLoading: false,
                error: null,
                connectionStatus: 'status-connecting',
                quote: null,
                companyProfile: null,
                candles: null,
                news: [],
                selectedPeriod: 'D',
                timePeriods: [
                    { value: 'D', zh: '日线', en: 'Day' },
                    { value: 'W', zh: '周线', en: 'Week' },
                    { value: 'M', zh: '月线', en: 'Month' }
                ],
                chart: null,
                
                async init() {
                    console.log("App Initializing...");
                    const savedLanguage = localStorage.getItem('language');
                    if (savedLanguage) this.language = savedLanguage;
                    await this.loadStock();
                    console.log("App Initialization Finished.");
                },
                
                async loadStock() {
                    console.log("loadStock() called for", this.symbol);
                    this.loading = true;
                    this.error = null;
                    this.connectionStatus = 'status-connecting';
                    const currentSymbol = this.symbol.toUpperCase();

                    try {
                        const [quoteData, profileData, newsData] = await Promise.all([
                            fetch(`/api/stock/quote?symbol=${currentSymbol}`).then(res => this.handleResponse(res, 'quote')),
                            fetch(`/api/stock/profile?symbol=${currentSymbol}`).then(res => this.handleResponse(res, 'profile')),
                            fetch(`/api/stock/news?symbol=${currentSymbol}`).then(res => this.handleResponse(res, 'news'))
                        ]);
                        
                        this.quote = quoteData;
                        this.companyProfile = profileData;
                        this.news = newsData;
                        this.connectionStatus = 'status-connected';
                        
                        await this.loadCandles();

                    } catch (error) {
                        console.error('Data Load Error:', error);
                        this.error = `[Data Load Error] ${error.message}`;
                        this.connectionStatus = 'status-disconnected';
                    } finally {
                        this.loading = false;
                    }
                },
                
                async changePeriod(newPeriod) {
                    if (this.selectedPeriod === newPeriod && this.chart) return;
                    this.selectedPeriod = newPeriod;
                    await this.loadCandles();
                },

                async loadCandles() {
                    console.log("loadCandles() called for period:", this.selectedPeriod);
                    this.chartLoading = true;
                    this.error = null; // 清除之前的图表错误
                    const currentSymbol = this.symbol.toUpperCase();
                    const resolution = this.selectedPeriod;
                    const to = Math.floor(Date.now() / 1000);
                    let from;
                    switch (resolution) {
                        case 'D': from = to - (365 * 24 * 60 * 60); break;
                        case 'W': from = to - (5 * 365 * 24 * 60 * 60); break;
                        case 'M': from = to - (20 * 365 * 24 * 60 * 60); break;
                        default: from = to - (365 * 24 * 60 * 60);
                    }
                    
                    try {
                        const url = `/api/stock/candles?symbol=${currentSymbol}&resolution=${resolution}&from=${from}&to=${to}`;
                        const candlesData = await fetch(url).then(res => this.handleResponse(res, 'candles'));
                        
                        console.log("Received candle data from API:", candlesData);

                        if (candlesData && candlesData.s === 'ok') {
                            this.candles = candlesData;
                        } else {
                            // 如果后端返回了 no_data 或者其他无效结构，也设置为空
                            this.candles = { s: 'no_data', t: [], c: [], o: [], h: [], l: [], v: [] };
                            // 可以选择在这里显示一个提示
                            // this.error = "No chart data available for this period.";
                        }
                        this.updateChart();
                    } catch (error) {
                        console.error('Chart Load Error:', error);
                        this.error = `[Chart Load Error] ${error.message}`;
                        this.candles = { s: 'error' }; // 设置一个错误状态
                        this.updateChart(); // 即使出错也调用updateChart，让它来处理空状态
                    } finally {
                        this.chartLoading = false;
                    }
                },

                async handleResponse(response, type) {
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: response.statusText }));
                        throw new Error(errorData.error || `Request for ${type} failed with status ${response.status}`);
                    }
                    return response.json();
                },
                
                updateChart() {
                    if (this.chart) this.chart.destroy();
                    const ctx = document.getElementById('stockChart');
                    
                    // 只有在数据真正有效时才创建图表
                    if (!ctx || !this.candles || this.candles.s !== 'ok' || !Array.isArray(this.candles.c) || this.candles.c.length === 0) {
                        console.warn("Invalid or empty data provided to chart. Aborting chart creation. Data was:", this.candles);
                        // 可以在这里显示 "No data to display" 的提示
                        return;
                    }
                    
                    // ... Chart.js 创建代码，和之前一样，无需改动 ...
                    // 为了简洁，这里省略
                },
                
                // ... 省略其他所有工具函数 ...
            }
        }
    </script>
</body>
</html>