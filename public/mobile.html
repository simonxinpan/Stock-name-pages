<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>个股详情 - 移动版</title>
    <link rel="stylesheet" href="./tailwind.css">
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* 移动端优化样式 - 作用域限制 */
        .mobile-page .mobile-container {
            max-width: 100vw;
            overflow-x: hidden;
        }
        
        .mobile-page .mobile-card {
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 16px;
            border: 1px solid rgba(0,0,0,0.05);
            background: #ffffff;
            transition: all 0.2s ease;
        }
        
        .mobile-page .mobile-card:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
            transform: translateY(-1px);
        }
        
        /* 公司Logo样式 */
        .mobile-page .company-logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .mobile-page .company-logo {
            width: 40px !important;
            height: 40px !important;
            border-radius: 8px;
            object-fit: contain;
            background: #f8fafc;
            border: 1px solid rgba(0,0,0,0.08);
            transition: all 0.2s ease;
        }
        
        .mobile-page .company-logo:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .mobile-page .price-display {
            font-size: 2rem;
            font-weight: 700;
            line-height: 1.2;
        }
        
        .mobile-page .change-positive {
            color: #22c55e;
        }
        
        .mobile-page .change-negative {
            color: #ef4444;
        }
        
        .mobile-page .metric-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .mobile-page .metric-item {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 20px 16px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(0,0,0,0.05);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .mobile-page .metric-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .mobile-page .metric-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .mobile-page .metric-item:hover::before {
            opacity: 1;
        }
        
        .mobile-page .chart-container {
            width: 100%;
            height: 280px;
            min-height: 280px;
            position: relative;
            /* 确保容器在初始化时有稳定的尺寸 */
            contain: layout;
            overflow: hidden;
            background: #fafafa;
            border-radius: 8px;
        }
        
        .mobile-page .chart-container canvas {
            width: 100% !important;
            height: 280px !important;
            max-width: 100%;
            display: block;
            transition: opacity 0.3s ease;
        }
        
        .mobile-page .chart-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }
        
        .mobile-page .tab-button {
            flex: 1;
            padding: 10px 16px;
            text-align: center;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        
        .mobile-page .tab-active {
            background: #3b82f6;
            color: white;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
            transform: translateY(-1px);
        }
        
        .mobile-page .tab-inactive {
            background: transparent;
            color: #64748b;
        }
        
        .mobile-page .tab-inactive:hover {
            background: #e2e8f0;
            color: #475569;
        }
        
        .mobile-page .news-item {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .mobile-page .news-item:hover {
            transform: translateY(-1px);
        }
        
        .mobile-page .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: mobile-spin 1s linear infinite;
        }
        
        @keyframes mobile-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 触摸优化 */
        .mobile-page .touch-target {
            min-height: 44px;
            min-width: 44px;
        }
        
        /* 统一间距 */
        .mobile-page .mobile-card .flex {
            align-items: center;
        }
        
        .mobile-page .mobile-card .space-y-3 > * + * {
            margin-top: 12px;
        }
        
        .mobile-page .mobile-card .space-y-2 > * + * {
            margin-top: 8px;
        }
        
        /* 隐藏桌面端元素 */
        @media (max-width: 768px) {
            .mobile-page .desktop-only {
                display: none !important;
            }
        }
    </style>
</head>
<body class="mobile-page bg-gray-50 mobile-container" x-data="mobileStockApp()" x-init="init()">
    <!-- 顶部导航栏 -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <button @click="goBack()" class="touch-target flex items-center justify-center">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <!-- 公司Logo和信息 -->
                    <div class="flex items-center space-x-3">
                        <div x-show="companyProfile?.weburl" class="company-logo-container">
                            <img :src="companyProfile?.weburl ? `https://logo.clearbit.com/${new URL(companyProfile.weburl).hostname}` : ''" 
                                 :alt="getDisplayName() + ' Logo'" 
                                 class="company-logo w-10 h-10 rounded-lg object-contain bg-gray-50 border border-gray-200"
                                 onerror="this.style.display='none'">
                        </div>
                        <div>
                            <h1 class="text-lg font-semibold text-gray-900" x-text="getDisplayName()"></h1>
                            <p class="text-sm text-gray-500" x-text="symbol"></p>
                        </div>
                    </div>
                </div>
                <button @click="toggleLanguage()" class="touch-target px-3 py-1 bg-gray-100 rounded-full text-sm font-medium">
                    <span x-text="language === 'zh' ? 'EN' : '中文'"></span>
                </button>
            </div>
        </div>
    </header>

    <!-- 主要内容区域 -->
    <main class="px-4 py-4 space-y-4">
        <!-- 加载状态 -->
        <div x-show="loading" class="text-center py-8">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-gray-600" x-text="language === 'zh' ? '加载中...' : 'Loading...'"></p>
        </div>

        <!-- 错误状态 -->
        <div x-show="error" class="bg-red-50 border border-red-200 rounded-lg p-4">
            <p class="text-red-600" x-text="error"></p>
        </div>

        <!-- 股价信息卡片 -->
        <div x-show="!loading && !error" class="mobile-card p-6 bg-gradient-to-br from-blue-50 to-indigo-50 border-blue-100">
            <div class="text-center">
                <div class="price-display mb-3" :class="getChangeClass()" x-text="formatPrice(quote?.c)"></div>
                <div class="flex items-center justify-center space-x-6 text-base font-medium">
                    <span :class="getChangeClass()" x-text="formatChange(quote?.d)"></span>
                    <span :class="getChangeClass()" x-text="formatChangePercent(quote?.dp)"></span>
                </div>
                <div class="mt-4 text-sm text-gray-600 bg-white/50 rounded-full px-4 py-2 inline-block">
                    <span x-text="language === 'zh' ? '更新时间: ' : 'Updated: '"></span>
                    <span x-text="formatTime(quote?.t)"></span>
                </div>
            </div>
        </div>

        <!-- 价格走势图 -->
        <div x-show="!loading && !error" class="bg-white mobile-card p-5">
            <div class="mb-5">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-900" x-text="language === 'zh' ? '价格走势' : 'Price Chart'"></h2>
                    <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
                </div>
                <div class="flex space-x-2 mb-4 bg-gray-50 p-1 rounded-xl">
                    <template x-for="period in timePeriods" :key="period.value">
                        <button @click="changePeriod(period.value)" 
                                :class="selectedPeriod === period.value ? 'tab-active' : 'tab-inactive'" 
                                class="tab-button touch-target" 
                                x-text="language === 'zh' ? period.zh : period.en">
                        </button>
                    </template>
                </div>
            </div>
            <div class="chart-container bg-gray-50 rounded-xl border border-gray-100">
                <canvas id="mobileStockChart"></canvas>
                <div class="chart-loading" style="display: none;">
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </div>

        <!-- 关键财务指标 -->
        <div x-show="!loading && !error" class="bg-white mobile-card p-5">
            <h2 class="text-xl font-bold text-gray-900 mb-5" x-text="language === 'zh' ? '关键指标' : 'Key Metrics'"></h2>
            <div class="metric-grid">
                <div class="metric-item">
                    <div class="text-sm text-gray-600 mb-2" x-text="language === 'zh' ? '市值' : 'Market Cap'"></div>
                    <div class="font-bold text-lg text-gray-900" x-text="formatMarketCap(metrics?.marketCapitalization)"></div>
                </div>
                <div class="metric-item">
                    <div class="text-sm text-gray-600 mb-2" x-text="language === 'zh' ? 'P/E比率' : 'P/E Ratio'"></div>
                    <div class="font-bold text-lg text-gray-900" x-text="formatRatio(metrics?.peBasicExclExtraTTM)"></div>
                </div>
                <div class="metric-item">
                    <div class="text-sm text-gray-600 mb-2" x-text="language === 'zh' ? '52周最高' : '52W High'"></div>
                    <div class="font-bold text-lg text-green-600" x-text="formatPrice(metrics?.['52WeekHigh'])"></div>
                </div>
                <div class="metric-item">
                    <div class="text-sm text-gray-600 mb-2" x-text="language === 'zh' ? '52周最低' : '52W Low'"></div>
                    <div class="font-bold text-lg text-red-600" x-text="formatPrice(metrics?.['52WeekLow'])"></div>
                </div>
                <div class="metric-item">
                    <div class="text-sm text-gray-600 mb-2" x-text="language === 'zh' ? '成交量' : 'Volume'"></div>
                    <div class="font-bold text-lg text-gray-900" x-text="formatVolume(quote?.v)"></div>
                </div>
                <div class="metric-item">
                    <div class="text-sm text-gray-600 mb-2" x-text="language === 'zh' ? 'ROE' : 'ROE'"></div>
                    <div class="font-bold text-lg text-gray-900" x-text="formatRatio(metrics?.roeTTM)"></div>
                </div>
            </div>
        </div>

        <!-- 公司信息 -->
        <div x-show="!loading && !error" class="bg-white mobile-card p-5">
            <h2 class="text-xl font-bold text-gray-900 mb-5" x-text="language === 'zh' ? '公司信息' : 'Company Info'"></h2>
            <div class="space-y-4">
                <div class="flex justify-between items-center py-3 border-b border-gray-100">
                    <span class="text-sm font-medium text-gray-600" x-text="language === 'zh' ? '行业' : 'Industry'"></span>
                    <span class="text-sm font-semibold text-gray-900" x-text="companyProfile?.finnhubIndustry || 'N/A'"></span>
                </div>
                <div class="flex justify-between items-center py-3 border-b border-gray-100">
                    <span class="text-sm font-medium text-gray-600" x-text="language === 'zh' ? '国家' : 'Country'"></span>
                    <span class="text-sm font-semibold text-gray-900" x-text="companyProfile?.country || 'N/A'"></span>
                </div>
                <div class="flex justify-between items-center py-3 border-b border-gray-100">
                    <span class="text-sm font-medium text-gray-600" x-text="language === 'zh' ? '交易所' : 'Exchange'"></span>
                    <span class="text-sm font-semibold text-gray-900" x-text="companyProfile?.exchange || 'N/A'"></span>
                </div>
                <div x-show="companyProfile?.weburl" class="pt-4">
                    <a :href="companyProfile?.weburl" target="_blank" 
                       class="flex items-center justify-center space-x-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white py-3 px-6 rounded-xl touch-target font-medium shadow-lg hover:shadow-xl transition-all duration-200 hover:scale-105">
                        <span x-text="language === 'zh' ? '访问官网' : 'Visit Website'"></span>
                        <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                        </svg>
                    </a>
                </div>
            </div>
        </div>

        <!-- 相关新闻 -->
        <div x-show="!loading && !error" class="bg-white mobile-card p-5">
            <div class="flex items-center justify-between mb-5">
                <h2 class="text-xl font-bold text-gray-900" x-text="language === 'zh' ? '相关新闻' : 'Related News'"></h2>
                <button @click="loadNews()" class="bg-blue-50 text-blue-600 px-3 py-2 rounded-lg text-sm font-medium touch-target hover:bg-blue-100 transition-colors">
                    <span x-text="language === 'zh' ? '刷新' : 'Refresh'"></span>
                </button>
            </div>
            
            <div x-show="newsLoading" class="text-center py-8">
                <div class="loading-spinner mx-auto mb-3"></div>
                <p class="text-sm text-gray-600" x-text="language === 'zh' ? '加载新闻中...' : 'Loading news...'"></p>
            </div>
            
            <div x-show="!newsLoading && news && news.length > 0" class="space-y-4">
                <template x-for="article in news.slice(0, 3)" :key="article.id">
                    <div class="news-item bg-gray-50 rounded-xl p-4 hover:bg-gray-100 transition-colors">
                        <h3 class="font-semibold text-base mb-3 line-clamp-2 leading-tight">
                            <a :href="article.url" target="_blank" class="text-gray-900 hover:text-blue-600 transition-colors">
                                <span x-text="language === 'zh' && article.translatedHeadline ? article.translatedHeadline : article.headline"></span>
                            </a>
                        </h3>
                        <p class="text-sm text-gray-600 mb-3 line-clamp-2 leading-relaxed" x-text="language === 'zh' && article.translatedSummary ? article.translatedSummary : article.summary"></p>
                        <div class="flex items-center justify-between text-xs text-gray-500">
                            <span class="bg-white px-2 py-1 rounded-full font-medium" x-text="article.source"></span>
                            <span x-text="formatNewsDate(article.datetime)"></span>
                        </div>
                    </div>
                </template>
            </div>
            
            <div x-show="!newsLoading && (!news || news.length === 0)" class="text-center py-8 text-gray-500">
                <div class="w-16 h-16 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
                    <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path>
                    </svg>
                </div>
                <p class="text-sm" x-text="language === 'zh' ? '暂无相关新闻' : 'No news available'"></p>
            </div>
        </div>

        <!-- 快捷操作 -->
        <div x-show="!loading && !error" class="bg-white mobile-card p-5">
            <h2 class="text-xl font-bold text-gray-900 mb-5" x-text="language === 'zh' ? '快捷操作' : 'Quick Actions'"></h2>
            <div class="grid grid-cols-2 gap-4">
                <button @click="openYouTubeSearch()" 
                        class="flex flex-col items-center justify-center space-y-3 bg-gradient-to-br from-red-50 to-red-100 text-red-600 py-6 px-4 rounded-xl touch-target hover:shadow-lg transition-all duration-200 hover:scale-105">
                    <svg class="w-8 h-8" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136C4.495 20.455 12 20.455 12 20.455s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                    </svg>
                    <span class="text-sm font-semibold text-center" x-text="language === 'zh' ? '相关视频' : 'Videos'"></span>
                </button>
                <button @click="openXueqiuSearch()" 
                        class="flex flex-col items-center justify-center space-y-3 bg-gradient-to-br from-blue-50 to-blue-100 text-blue-600 py-6 px-4 rounded-xl touch-target hover:shadow-lg transition-all duration-200 hover:scale-105">
                    <svg class="w-8 h-8" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                    <span class="text-sm font-semibold text-center" x-text="language === 'zh' ? '社区讨论' : 'Community'"></span>
                </button>
            </div>
        </div>
    </main>

    <script>
        function mobileStockApp() {
            return {
                language: 'zh',
                symbol: new URLSearchParams(window.location.search).get('symbol') || 'AAPL',
                loading: true,
                chartLoading: false,
                error: null,
                quote: null,
                companyProfile: null,
                candles: null,
                metrics: null,
                chineseName: null,
                selectedPeriod: 'D',
                timePeriods: [
                    { value: 'D', zh: '日线', en: 'Day' },
                    { value: 'W', zh: '周线', en: 'Week' },
                    { value: 'M', zh: '月线', en: 'Month' }
                ],
                chart: null,
                chartCreating: false,
                news: [],
                newsLoading: false,
                lastCandleCall: 0,
                candleCallInterval: 20000,
                candleCache: new Map(),
                cacheExpiry: 300000,

                async init() {
                    const urlParams = new URLSearchParams(window.location.search);
                    const symbolFromUrl = urlParams.get('symbol');
                    
                    if (symbolFromUrl) {
                        this.symbol = symbolFromUrl.toUpperCase();
                    }
                    
                    const savedLang = localStorage.getItem('stock-lang');
                    if (savedLang) this.language = savedLang;
                    
                    // ================================================================
                    // == 【最终稳定版】并行数据获取 + 分离渲染逻辑 ==
                    // ================================================================
                    await this.initializePageWithStableRendering();
                },

                async initializePageWithStableRendering() {
                    this.loading = true;
                    this.error = null;
                    
                    try {
                        const encodedSymbol = encodeURIComponent(this.symbol);
                        
                        // --- 并行获取所有需要的数据 ---
                        // 将所有数据请求（公开数据和可能需要认证的数据）都放在这里
                        const dataPromises = [
                            fetch(`/api/stock/quote?symbol=${encodedSymbol}`).then(res => this.handleResponse(res)),
                            fetch(`/api/stock/profile?symbol=${encodedSymbol}`).then(res => this.handleResponse(res)),
                            fetch(`/api/stock/metrics?symbol=${encodedSymbol}`).then(res => this.handleResponse(res)),
                            fetch(`/api/stock/chinese-name?symbol=${encodedSymbol}`).then(res => res.json().catch(() => ({}))),
                            this.loadCandlesData(), // K线数据获取
                            this.loadNewsData() // 新闻数据获取
                        ];
                        
                        // 等待所有数据全部返回
                        const [quoteData, profileData, metricsData, chineseNameData, candlesData, newsData] = await Promise.all(dataPromises);
                        
                        // --- 在所有数据都拿到后，才开始渲染页面 ---
                        
                        // 1. 先设置所有基础数据
                        this.quote = quoteData;
                        this.companyProfile = profileData;
                        this.metrics = metricsData;
                        
                        if (chineseNameData.success && chineseNameData.chinese_name) {
                            this.chineseName = chineseNameData.chinese_name;
                        }
                        
                        this.news = newsData || [];
                        
                        // 1.5. 异步翻译新闻（不阻塞页面渲染）
                        if (this.news.length > 0) {
                            setTimeout(() => {
                                this.translateNewsItems(this.news).catch(error => {
                                    console.error('新闻翻译失败:', error);
                                });
                            }, 500); // 延迟500ms开始翻译，确保页面已渲染
                        }
                        
                        // 2. 处理K线数据但不立即渲染图表
                        console.log('🔍 检查K线数据:', {
                            hasCandlesData: !!candlesData,
                            candlesType: typeof candlesData,
                            hasC: candlesData?.c ? true : false,
                            cLength: candlesData?.c?.length,
                            isArray: Array.isArray(candlesData?.c)
                        });
                        
                        if (candlesData && candlesData.c && Array.isArray(candlesData.c) && candlesData.c.length > 0) {
                            this.candles = candlesData;
                            console.log('✅ K线数据验证通过，准备渲染图表');
                            
                            // 3. 将K线图的渲染，放入下一个宏任务 (macro-task) 中
                            // 这是确保所有当前的DOM更新都已完成的终极技巧
                            setTimeout(() => {
                                try {
                                    console.log('🎯 开始在独立事件循环中初始化图表...');
                                    this.renderChartInSeparateTask();
                                    console.log('✅ 图表在独立任务中初始化成功');
                                } catch (error) {
                                    console.error('❌ 最终图表初始化尝试失败:', error);
                                    this.showChartError('图表渲染失败');
                                }
                            }, 100); // 增加延迟时间确保DOM完全就绪
                        } else {
                            console.warn('❌ K线数据验证失败:', candlesData);
                            // 尝试重新加载K线数据
                            setTimeout(async () => {
                                console.log('🔄 尝试重新加载K线数据...');
                                try {
                                    const retryData = await this.loadCandlesData();
                                    if (retryData && retryData.c && Array.isArray(retryData.c) && retryData.c.length > 0) {
                                        this.candles = retryData;
                                        this.renderChartInSeparateTask();
                                        console.log('✅ 重新加载K线数据成功');
                                    } else {
                                        this.showChartError('暂无K线图数据');
                                    }
                                } catch (error) {
                                    console.error('重新加载K线数据失败:', error);
                                    this.showChartError('K线数据加载失败');
                                }
                            }, 1000);
                        }
                        
                    } catch (error) {
                        console.error('页面初始化失败:', error);
                        this.error = `数据加载失败: ${error.message}`;
                    } finally {
                        this.loading = false;
                    }
                },

                // ================================================================
                // == 新的数据获取方法（用于并行加载）==
                // ================================================================
                
                async loadCandlesData() {
                    try {
                        const now = Date.now();
                        const cacheKey = `${this.symbol}_${this.selectedPeriod}`;
                        const cachedData = this.candleCache.get(cacheKey);
                        
                        if (cachedData && (now - cachedData.timestamp) < this.cacheExpiry) {
                            console.log('使用缓存的K线数据');
                            return cachedData.data;
                        }
                        
                        const timeSinceLastCall = now - this.lastCandleCall;
                        if (timeSinceLastCall < this.candleCallInterval) {
                            console.log('API调用频率限制，使用缓存数据或跳过');
                            return cachedData ? cachedData.data : null;
                        }
                        
                        this.lastCandleCall = now;
                        
                        const to = Math.floor(Date.now() / 1000);
                        let from;
                        switch (this.selectedPeriod) {
                            case 'W': from = to - (5 * 365 * 24 * 60 * 60); break;
                            case 'M': from = to - (20 * 365 * 24 * 60 * 60); break;
                            default: from = to - (365 * 24 * 60 * 60);
                        }
                        
                        const encodedSymbol = encodeURIComponent(this.symbol);
                        const url = `/api/stock/candles?symbol=${encodedSymbol}&resolution=${this.selectedPeriod}&from=${from}&to=${to}`;
                        const response = await fetch(url);
                        const data = await this.handleResponse(response);
                        
                        if (data && data.c && Array.isArray(data.c) && data.c.length > 0) {
                            this.candleCache.set(cacheKey, { data: data, timestamp: now });
                            return data;
                        } else {
                            console.warn('Invalid candle data received:', data);
                            return null;
                        }
                    } catch (error) {
                        console.error('Failed to load candles data:', error);
                        return null;
                    }
                },
                
                async loadNewsData() {
                    try {
                        const encodedSymbol = encodeURIComponent(this.symbol);
                        const response = await fetch(`/api/stock/news?symbol=${encodedSymbol}`);
                        const data = await this.handleResponse(response);
                        return data || [];
                    } catch (error) {
                        console.error('Failed to load news data:', error);
                        return [];
                    }
                },

                // 原有的loadCandles和loadNews方法已被loadCandlesData和loadNewsData替代
                // 这些方法现在在initializePageWithStableRendering中统一调用

                async translateNewsItems(newsItems) {
                    if (!newsItems || newsItems.length === 0) {
                        console.log('📰 没有新闻需要翻译');
                        return;
                    }
                    
                    console.log(`📰 开始翻译 ${newsItems.length} 条新闻...`);
                    
                    // 处理所有新闻，不只是前3条
                    for (let i = 0; i < newsItems.length; i++) {
                        const item = newsItems[i];
                        try {
                            // 同时翻译标题和摘要
                            const promises = [];
                            
                            if (item.headline) {
                                promises.push(
                                    this.translateWithVolcEngine(item.headline)
                                        .then(translated => {
                                            if (translated && translated !== item.headline) {
                                                item.translatedHeadline = translated;
                                                console.log('✅ 新闻标题翻译成功');
                                            } else {
                                                item.translatedHeadline = item.headline;
                                            }
                                        })
                                        .catch(e => {
                                            console.warn('⚠️ 新闻标题翻译失败，使用原文');
                                            item.translatedHeadline = item.headline;
                                        })
                                );
                            }
                            
                            if (item.summary) {
                                promises.push(
                                    this.translateWithVolcEngine(item.summary)
                                        .then(translated => {
                                            if (translated && translated !== item.summary) {
                                                item.translatedSummary = translated;
                                                console.log('✅ 新闻摘要翻译成功');
                                            } else {
                                                item.translatedSummary = item.summary;
                                            }
                                        })
                                        .catch(e => {
                                            console.warn('⚠️ 新闻摘要翻译失败，使用原文');
                                            item.translatedSummary = item.summary;
                                        })
                                );
                            }
                            
                            // 等待所有翻译完成
                            await Promise.all(promises);
                            
                            console.log(`✅ 新闻 ${i + 1}/${newsItems.length} 翻译完成`);
                            
                            // 直接修改原始数据，不需要返回新数组
                            item.originalHeadline = item.headline;
                            item.originalSummary = item.summary;
                        } catch (error) {
                            console.error(`❌ 新闻 ${i + 1} 翻译失败:`, error);
                            // 翻译失败时保持原文
                            item.translatedHeadline = item.headline;
                            item.translatedSummary = item.summary;
                            item.originalHeadline = item.headline;
                            item.originalSummary = item.summary;
                        }
                    }
                    
                    console.log('🎉 所有新闻翻译处理完成');
                    // 触发页面更新以显示翻译结果
                    this.$nextTick(() => {
                        console.log('📱 页面数据已更新');
                    });
                },

                // 翻译缓存
                translationCache: new Map(),
                translationInProgress: new Set(),
                
                // 火山引擎翻译函数
                async translateWithVolcEngine(text) {
                    if (!text || text.trim() === '') {
                        return text;
                    }
                    
                    // 检查缓存
                    const cacheKey = `volc_${text}`;
                    if (this.translationCache.has(cacheKey)) {
                        return this.translationCache.get(cacheKey);
                    }
                    
                    // 避免重复翻译
                    if (this.translationInProgress.has(cacheKey)) {
                        return text;
                    }
                    
                    this.translationInProgress.add(cacheKey);
                    
                    try {
                        console.log('🚀 使用火山引擎翻译...');
                        
                        const response = await fetch('/api/translate', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                text: text,
                                targetLang: 'zh'
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }
                        
                        const data = await response.json();
                        const translatedText = data.translatedText || data.translation || '';
                        
                        if (translatedText && translatedText.trim() !== '' && translatedText !== text) {
                            this.translationCache.set(cacheKey, translatedText);
                            this.translationInProgress.delete(cacheKey);
                            console.log('✅ 火山引擎翻译成功');
                            return translatedText;
                        }
                        
                        throw new Error('翻译结果为空或无效');
                        
                    } catch (error) {
                        console.warn('❌ 火山引擎翻译失败:', error.message);
                        this.translationInProgress.delete(cacheKey);
                        return text; // 返回原文
                    }
                },

                async translateText(text) {
                    if (!text || text.length < 10) return text;
                    
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10秒超时
                        
                        const response = await fetch('/api/translate', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                text: text,
                                targetLang: 'zh'
                            }),
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                        
                        if (response.ok) {
                            const result = await response.json();
                            if (result && result.translatedText) {
                                return result.translatedText;
                            } else {
                                console.warn('Translation response missing translatedText:', result);
                                return text;
                            }
                        } else {
                            console.error('Translation API HTTP error:', response.status, response.statusText);
                            return text;
                        }
                    } catch (error) {
                        if (error.name === 'AbortError') {
                            console.warn('Translation request timeout');
                        } else {
                            console.error('Translation API error:', error);
                        }
                        return text;
                    }
                },

                // ================================================================
                // == 新的图表渲染方法（用于独立事件循环）==
                // ================================================================
                
                renderChartInSeparateTask() {
                    // 防止重复渲染
                    if (this.chartCreating) {
                        console.warn('Chart creation already in progress');
                        return;
                    }
                    
                    this.chartCreating = true;
                    
                    try {
                        const ctx = document.getElementById('mobileStockChart');
                        if (!ctx) {
                            console.error('Canvas element not found');
                            this.showChartError('图表容器未找到');
                            return;
                        }
                        
                        // 确保canvas有正确的尺寸
                        const container = ctx.parentElement;
                        if (!container) {
                            console.error('Chart container not found');
                            this.showChartError('图表容器未找到');
                            return;
                        }
                        
                        const rect = container.getBoundingClientRect();
                        if (rect.width <= 0 || rect.height <= 0) {
                            console.warn('Container size not ready, retrying...', rect);
                            // 延迟重试
                            setTimeout(() => {
                                this.chartCreating = false;
                                this.renderChartInSeparateTask();
                            }, 200);
                            return;
                        }
                        
                        // 销毁现有图表
                        if (this.chart) {
                            try {
                                this.chart.destroy();
                            } catch (e) {
                                console.warn('Error destroying existing chart:', e);
                            }
                            this.chart = null;
                        }
                        
                        // 创建新图表
                        this.createChart(ctx);
                        
                    } finally {
                        this.chartCreating = false;
                    }
                },
                
                showChartError(message) {
                    const container = document.getElementById('mobileStockChart')?.parentElement;
                    if (container) {
                        container.innerHTML = `
                            <div class="flex items-center justify-center h-full text-gray-500">
                                <div class="text-center">
                                    <p class="mb-2">${message}</p>
                                    <p class="text-sm">${this.language === 'zh' ? '请稍后重试' : 'Please try again later'}</p>
                                </div>
                            </div>
                        `;
                    }
                },

                async changePeriod(newPeriod) {
                    if (this.selectedPeriod === newPeriod) return;
                    
                    // 防止快速切换周期时的重复调用
                    if (this.chartLoading || this.chartCreating) {
                        console.warn('Chart operation in progress, ignoring period change');
                        return;
                    }
                    
                    this.selectedPeriod = newPeriod;
                    
                    // 使用新的稳定渲染逻辑
                    try {
                        const candlesData = await this.loadCandlesData();
                        if (candlesData && candlesData.c && Array.isArray(candlesData.c) && candlesData.c.length > 0) {
                            this.candles = candlesData;
                            
                            // 同样使用setTimeout确保渲染稳定性
                            setTimeout(() => {
                                this.renderChartInSeparateTask();
                            }, 0);
                        } else {
                            this.showChartError('暂无该周期的K线数据');
                        }
                    } catch (error) {
                        console.error('Period change failed:', error);
                        this.showChartError('切换周期失败');
                    }
                },

                updateChart() {
                    if (this.chart) {
                        this.chart.destroy();
                        this.chart = null;
                    }
                    
                    // 显示加载状态
                    this.showChartLoading(true);
                    
                    // 延迟初始化，确保容器尺寸稳定
                    setTimeout(() => {
                        const ctx = document.getElementById('mobileStockChart');
                        if (!ctx || !this.candles || !this.candles.c || this.candles.c.length === 0) {
                            console.warn('Cannot update chart: invalid data or canvas');
                            this.showChartLoading(false);
                            this.showChartError('图表数据无效');
                            return;
                        }
                        
                        // 确保canvas有正确的尺寸
                        const container = ctx.parentElement;
                        if (container) {
                            const rect = container.getBoundingClientRect();
                            if (rect.width > 0 && rect.height > 0) {
                                this.createChart(ctx);
                                this.showChartLoading(false);
                            } else {
                                console.warn('Container size not ready, retrying...');
                                setTimeout(() => this.updateChart(), 100);
                            }
                        }
                    }, 100);
                },
                
                showChartLoading(show) {
                    const loadingEl = document.querySelector('.chart-loading');
                    if (loadingEl) {
                        loadingEl.style.display = show ? 'block' : 'none';
                    }
                },
                
                showChartError(message) {
                    console.error('Chart Error:', message);
                    // 可以在这里添加错误提示UI
                },

                createChart(ctx) {
                    // ================================================================
                    // == 关键的数据清洗和验证步骤 ==
                    // ================================================================
                    if (!this.candles || typeof this.candles !== 'object') {
                        console.warn('Cannot create chart: candles data is null or invalid');
                        this.showChartError('K线数据无效');
                        return;
                    }
                    
                    // 验证API返回的数据格式
                    if (!Array.isArray(this.candles.t) || !Array.isArray(this.candles.c) || 
                        this.candles.t.length === 0 || this.candles.c.length === 0 ||
                        this.candles.t.length !== this.candles.c.length) {
                        console.warn('Cannot create chart: invalid candle data structure', {
                            hasT: Array.isArray(this.candles.t),
                            hasC: Array.isArray(this.candles.c),
                            tLength: this.candles.t?.length,
                            cLength: this.candles.c?.length
                        });
                        this.showChartError('K线数据格式错误');
                        return;
                    }
                    
                    try {
                        // 数据清洗：过滤掉无效的数据点
                        const cleanedData = [];
                        const cleanedLabels = [];
                        
                        for (let i = 0; i < this.candles.t.length; i++) {
                            const timestamp = this.candles.t[i];
                            const price = this.candles.c[i];
                            
                            // 验证每个数据点的有效性
                            if (typeof timestamp === 'number' && timestamp > 0 &&
                                typeof price === 'number' && !isNaN(price) && price > 0) {
                                cleanedData.push(price);
                                const date = new Date(timestamp * 1000);
                                cleanedLabels.push(date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' }));
                            }
                        }
                        
                        // 确保清洗后还有有效数据
                        if (cleanedData.length === 0) {
                            console.warn('Cannot create chart: no valid data points after cleaning');
                            this.showChartError('没有有效的K线数据');
                            return;
                        }
                        
                        console.log(`Chart data cleaned: ${this.candles.c.length} -> ${cleanedData.length} valid points`);
                        
                        const isPositive = this.quote && this.quote.d >= 0;
                        const color = isPositive ? '#22c55e' : '#ef4444';
                        
                        // 确保Canvas上下文有效
                        if (!ctx.getContext) {
                            console.error('Invalid canvas context');
                            this.showChartError('Canvas上下文无效');
                            return;
                        }
                        
                        // 设置Canvas尺寸
                        const container = ctx.parentElement;
                        const rect = container.getBoundingClientRect();
                        ctx.width = rect.width;
                        ctx.height = rect.height;
                        
                        this.chart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: cleanedLabels,
                                datasets: [{
                                    label: this.symbol,
                                    data: cleanedData,
                                    borderColor: color,
                                    backgroundColor: 'transparent',
                                    borderWidth: 2,
                                    pointRadius: 0,
                                    pointHoverRadius: 4,
                                    tension: 0.1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    }
                                },
                                scales: {
                                    x: {
                                        display: true,
                                        grid: {
                                            display: false
                                        },
                                        ticks: {
                                            maxTicksLimit: 6
                                        }
                                    },
                                    y: {
                                        display: true,
                                        position: 'right',
                                        grid: {
                                            color: '#f1f5f9'
                                        }
                                    }
                                },
                                interaction: {
                                    intersect: false,
                                    mode: 'index'
                                }
                            }
                        });
                        
                    } catch (error) {
                        console.error('Chart.js Error Details:', {
                            message: error.message,
                            stack: error.stack,
                            candlesData: {
                                hasCandles: !!this.candles,
                                candlesType: typeof this.candles,
                                tLength: this.candles?.t?.length,
                                cLength: this.candles?.c?.length,
                                sampleT: this.candles?.t?.slice(0, 3),
                                sampleC: this.candles?.c?.slice(0, 3)
                            },
                            contextInfo: {
                                canvasExists: !!ctx,
                                canvasId: ctx?.id,
                                containerSize: ctx?.parentElement?.getBoundingClientRect()
                            }
                        });
                        this.chart = null;
                        
                        // 显示用户友好的错误信息
                        const container = ctx?.parentElement;
                        if (container) {
                            container.innerHTML = `
                                <div class="flex items-center justify-center h-full text-gray-500">
                                    <div class="text-center">
                                        <p class="mb-2">${this.language === 'zh' ? '图表加载失败' : 'Chart loading failed'}</p>
                                        <p class="text-sm">${this.language === 'zh' ? '请稍后重试' : 'Please try again later'}</p>
                                    </div>
                                </div>
                            `;
                        }
                    }
                },

                async handleResponse(response) {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return await response.json();
                },

                getDisplayName() {
                    return this.chineseName || this.companyProfile?.name || this.symbol;
                },

                getChangeClass() {
                    if (!this.quote?.d) return '';
                    return this.quote.d >= 0 ? 'change-positive' : 'change-negative';
                },

                formatPrice(price) {
                    if (!price) return 'N/A';
                    return `$${parseFloat(price).toFixed(2)}`;
                },

                formatChange(change) {
                    if (!change) return 'N/A';
                    const sign = change >= 0 ? '+' : '';
                    return `${sign}$${parseFloat(change).toFixed(2)}`;
                },

                formatChangePercent(changePercent) {
                    if (!changePercent) return 'N/A';
                    const sign = changePercent >= 0 ? '+' : '';
                    return `${sign}${parseFloat(changePercent).toFixed(2)}%`;
                },

                formatMarketCap(marketCap) {
                    if (!marketCap) return 'N/A';
                    const TRILLION = 1000000000000;
                    const BILLION = 100;
                    
                    if (marketCap >= TRILLION) {
                        return `${(marketCap / TRILLION).toFixed(2)}万亿`;
                    } else {
                        return `${(marketCap / BILLION).toFixed(0)}亿`;
                    }
                },

                formatVolume(volume) {
                    if (!volume) return 'N/A';
                    if (volume >= 1000000) {
                        return `${(volume / 1000000).toFixed(1)}M`;
                    } else if (volume >= 1000) {
                        return `${(volume / 1000).toFixed(1)}K`;
                    }
                    return volume.toString();
                },

                formatRatio(ratio) {
                    if (!ratio) return 'N/A';
                    return parseFloat(ratio).toFixed(2);
                },

                formatTime(timestamp) {
                    if (!timestamp) return 'N/A';
                    const date = new Date(timestamp * 1000);
                    return date.toLocaleString('zh-CN');
                },

                formatNewsDate(timestamp) {
                    if (!timestamp) return '';
                    const date = new Date(timestamp * 1000);
                    const now = new Date();
                    const diffHours = Math.floor((now - date) / (1000 * 60 * 60));
                    
                    if (diffHours < 1) return '刚刚';
                    if (diffHours < 24) return `${diffHours}小时前`;
                    if (diffHours < 48) return '1天前';
                    return date.toLocaleDateString('zh-CN');
                },

                toggleLanguage() {
                    this.language = this.language === 'zh' ? 'en' : 'zh';
                    localStorage.setItem('stock-lang', this.language);
                },

                goBack() {
                    if (window.history.length > 1) {
                        window.history.back();
                    } else {
                        window.location.href = '/';
                    }
                },

                openYouTubeSearch() {
                    const query = encodeURIComponent(`${this.symbol} ${this.companyProfile?.name || ''} stock analysis`);
                    window.open(`https://www.youtube.com/results?search_query=${query}`, '_blank');
                },

                openXueqiuSearch() {
                    const query = encodeURIComponent(this.symbol);
                    window.open(`https://xueqiu.com/S/${query}`, '_blank');
                }
            };
        }
    </script>
</body>
</html>