<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>个股详情 - 移动版</title>
    <link rel="stylesheet" href="./tailwind.css">
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* 移动端优化样式 - 作用域限制 (保留原有样式) */
        .mobile-page .mobile-container {
            max-width: 100vw;
            overflow-x: hidden;
        }
        
        .mobile-page .mobile-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(59, 130, 246, 0.08);
            margin-bottom: 16px;
            border: 1px solid rgba(59, 130, 246, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .mobile-page .mobile-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
        }
        
        .mobile-page .card-header {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 16px 20px 12px;
            border-bottom: 1px solid rgba(59, 130, 246, 0.1);
            margin: -1px -1px 0 -1px;
        }
        
        .mobile-page .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .mobile-page .card-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: #3b82f6;
            border-radius: 2px;
        }
        
        .mobile-page .price-display {
            font-size: 2rem;
            font-weight: 700;
            line-height: 1.2;
        }
        
        .mobile-page .change-positive {
            color: #22c55e;
        }
        
        .mobile-page .change-negative {
            color: #ef4444;
        }
        
        .mobile-page .metric-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .mobile-page .metric-item {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 16px 12px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(59, 130, 246, 0.1);
            position: relative;
            transition: all 0.2s ease;
        }
        
        .mobile-page .metric-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }
        
        .mobile-page .metric-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 2px;
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
            border-radius: 0 0 2px 2px;
        }
        
        .mobile-page .chart-container {
            width: 100%;
            height: 280px;
            min-height: 280px;
            position: relative;
            contain: layout;
            overflow: hidden;
            background: #fafafa;
            border-radius: 8px;
        }
        
        .mobile-page .chart-container canvas {
            width: 100% !important;
            height: 280px !important;
            max-width: 100%;
            display: block;
            transition: opacity 0.3s ease;
        }
        
        .mobile-page .chart-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }
        
        .mobile-page .tab-button {
            flex: 1;
            padding: 8px 12px;
            text-align: center;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .mobile-page .tab-active {
            background: #3b82f6;
            color: white;
        }
        
        .mobile-page .tab-inactive {
            background: #f1f5f9;
            color: #64748b;
        }
        
        .mobile-page .news-item {
            border-bottom: 1px solid rgba(59, 130, 246, 0.1);
            padding: 16px 0;
            position: relative;
            transition: all 0.2s ease;
        }
        
        .mobile-page .news-item:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.02) 0%, rgba(147, 197, 253, 0.02) 100%);
            border-radius: 8px;
            margin: 0 -8px;
            padding: 16px 8px;
        }
        
        .mobile-page .news-item:last-child {
            border-bottom: none;
        }
        
        .mobile-page .news-item::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 0;
            background: linear-gradient(180deg, #3b82f6, #60a5fa);
            border-radius: 2px;
            transition: height 0.2s ease;
        }
        
        .mobile-page .news-item:hover::before {
            height: 60%;
        }
        
        .mobile-page .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: mobile-spin 1s linear infinite;
        }
        
        @keyframes mobile-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .mobile-page .touch-target {
            min-height: 44px;
            min-width: 44px;
        }
        
        .mobile-page .mobile-card .flex {
            align-items: center;
        }
        
        .mobile-page .mobile-card .space-y-3 > * + * {
            margin-top: 12px;
        }
        
        .mobile-page .mobile-card .space-y-2 > * + * {
            margin-top: 8px;
        }
        
        @media (max-width: 768px) {
            .mobile-page .desktop-only {
                display: none !important;
            }
        }

        /* 
        ==================================================================
        === ✨ 新增的CSS覆盖样式，用于实现您的三项修改要求 ✨ ===
        ==================================================================
        */

        /* --- 任务1：顶部股票名称和代码，居中、加粗、加大、更醒目 --- */
        header .flex-1.text-center h1 {
            font-size: 26px !important;      /* 显著加大字体 */
            font-weight: 800 !important;     /* 字体加粗 (Extra Bold) */
            line-height: 1.1 !important;
        }

        header .flex-1.text-center p {
            font-size: 18px !important;      /* 加大字体 */
            font-weight: 600 !important;     /* 字体加粗 (Semi-bold) */
        }


        /* --- 任务2：相关新闻标题颜色改为蓝色 --- */
        .mobile-page .news-item h3 a {
            color: #007bff !important; /* 使用醒目的标准蓝色，并确保覆盖Tailwind的类 */
        }
        .mobile-page .news-item h3 a:hover {
            color: #0056b3 !important; /* 鼠标悬停时颜色加深 */
        }


        /* --- 任务3：底部图标颜色修改 --- */
        
        /* 布局已由 grid grid-cols-2 实现，此处仅修改颜色 */

        /* “相关视频”按钮的图标颜色强制为红色 */
        button[onclick^="openYouTubeSearch"] svg {
            color: #ff3b30 !important; /* 使用一个鲜艳的红色 */
        }
        /* “相关视频”按钮的文字颜色 */
        button[onclick^="openYouTubeSearch"] span {
            color: #c72c23 !important;
        }

        /* “社区讨论”按钮的图标颜色强制为蓝色 */
        button[onclick^="openXueqiuSearch"] svg {
            color: #007bff !important; /* 使用与新闻标题一致的蓝色 */
        }
        /* “社区讨论”按钮的文字颜色 */
        button[onclick^="openXueqiuSearch"] span {
            color: #0063cc !important;
        }
    </style>
</head>
<body class="mobile-page bg-gray-50 mobile-container" x-data="mobileStockApp()" x-init="init()">
    <!-- 顶部导航栏 -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="px-4 py-4">
            <div class="flex items-center justify-between">
                <button @click="goBack()" class="touch-target flex items-center justify-center">
                    <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
                
                <!-- 居中的股票信息 -->
                <div class="flex-1 text-center mx-4 py-2">
                    <h1 class="text-2xl font-black text-gray-900 leading-tight mb-1" x-text="getDisplayName()"></h1>
                    <p class="text-xl font-bold text-blue-600 tracking-wider" x-text="symbol"></p>
                </div>
                
                <button @click="toggleLanguage()" class="touch-target px-3 py-1 bg-gray-100 rounded-full text-sm font-medium">
                    <span x-text="language === 'zh' ? 'EN' : '中文'"></span>
                </button>
            </div>
        </div>
    </header>

    <!-- 主要内容区域 -->
    <main class="px-4 py-4 space-y-4">
        <!-- 加载状态 -->
        <div x-show="loading" class="text-center py-8">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-gray-600" x-text="language === 'zh' ? '加载中...' : 'Loading...'"></p>
        </div>

        <!-- 错误状态 -->
        <div x-show="error" class="bg-red-50 border border-red-200 rounded-lg p-4">
            <p class="text-red-600" x-text="error"></p>
        </div>

        <!-- 股价信息卡片 -->
        <div x-show="!loading && !error" class="mobile-card">
            <div class="card-header">
                <h2 class="card-title" x-text="language === 'zh' ? '实时股价' : 'Live Price'"></h2>
            </div>
            <div class="p-4">
                <div class="text-center">
                    <div class="price-display mb-2" :class="getChangeClass()" x-text="formatPrice(quote?.c)"></div>
                    <div class="flex items-center justify-center space-x-4 text-sm">
                        <span :class="getChangeClass()" x-text="formatChange(quote?.d)"></span>
                        <span :class="getChangeClass()" x-text="formatChangePercent(quote?.dp)"></span>
                    </div>
                    <div class="mt-3 text-xs text-gray-500">
                        <span x-text="language === 'zh' ? '更新时间: ' : 'Updated: '"></span>
                        <span x-text="formatTime(quote?.t)"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 价格走势图 -->
        <div x-show="!loading && !error" class="mobile-card">
            <div class="card-header">
                <h2 class="card-title" x-text="language === 'zh' ? '价格走势' : 'Price Chart'"></h2>
            </div>
            <div class="p-4">
                <div class="flex space-x-2 mb-4">
                    <template x-for="period in timePeriods" :key="period.value">
                        <button @click="changePeriod(period.value)" 
                                :class="selectedPeriod === period.value ? 'tab-active' : 'tab-inactive'" 
                                class="tab-button touch-target" 
                                x-text="language === 'zh' ? period.zh : period.en">
                        </button>
                    </template>
                </div>
            <div class="chart-container bg-gray-50 rounded-lg">
                <canvas id="mobileStockChart"></canvas>
                <div class="chart-loading" style="display: none;">
                    <div class="loading-spinner"></div>
                </div>
            </div>
            </div>
        </div>

        <!-- 关键财务指标 -->
        <div x-show="!loading && !error" class="mobile-card">
            <div class="card-header">
                <h2 class="card-title" x-text="language === 'zh' ? '关键指标' : 'Key Metrics'"></h2>
            </div>
            <div class="p-4">
            <div class="metric-grid">
                <div class="metric-item">
                    <div class="text-xs text-gray-500 mb-1" x-text="language === 'zh' ? '市值' : 'Market Cap'"></div>
                    <div class="font-semibold" x-text="formatMarketCap(metrics?.marketCapitalization)"></div>
                </div>
                <div class="metric-item">
                    <div class="text-xs text-gray-500 mb-1" x-text="language === 'zh' ? 'P/E比率' : 'P/E Ratio'"></div>
                    <div class="font-semibold" x-text="formatRatio(metrics?.peBasicExclExtraTTM)"></div>
                </div>
                <div class="metric-item">
                    <div class="text-xs text-gray-500 mb-1" x-text="language === 'zh' ? '52周最高' : '52W High'"></div>
                    <div class="font-semibold" x-text="formatPrice(metrics?.['52WeekHigh'])"></div>
                </div>
                <div class="metric-item">
                    <div class="text-xs text-gray-500 mb-1" x-text="language === 'zh' ? '52周最低' : '52W Low'"></div>
                    <div class="font-semibold" x-text="formatPrice(metrics?.['52WeekLow'])"></div>
                </div>
                <div class="metric-item">
                    <div class="text-xs text-gray-500 mb-1" x-text="language === 'zh' ? '成交量' : 'Volume'"></div>
                    <div class="font-semibold" x-text="formatVolume(quote?.v)"></div>
                </div>
                <div class="metric-item">
                    <div class="text-xs text-gray-500 mb-1" x-text="language === 'zh' ? 'ROE' : 'ROE'"></div>
                    <div class="font-semibold" x-text="formatRatio(metrics?.roeTTM)"></div>
                </div>
            </div>
            </div>
        </div>

        <!-- 公司信息 -->
        <div x-show="!loading && !error" class="mobile-card">
            <div class="card-header">
                <h2 class="card-title" x-text="language === 'zh' ? '公司信息' : 'Company Info'"></h2>
            </div>
            <div class="p-4">
            <div class="space-y-3">
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600" x-text="language === 'zh' ? '行业' : 'Industry'"></span>
                    <span class="text-sm font-medium" x-text="companyProfile?.finnhubIndustry || 'N/A'"></span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600" x-text="language === 'zh' ? '国家' : 'Country'"></span>
                    <span class="text-sm font-medium" x-text="companyProfile?.country || 'N/A'"></span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600" x-text="language === 'zh' ? '交易所' : 'Exchange'"></span>
                    <span class="text-sm font-medium" x-text="companyProfile?.exchange || 'N/A'"></span>
                </div>
            </div>
            </div>
        </div>

        <!-- 相关新闻 -->
        <div x-show="!loading && !error" class="mobile-card">
            <div class="card-header">
                <div class="flex items-center justify-between w-full">
                    <h2 class="card-title" x-text="language === 'zh' ? '相关新闻' : 'Related News'"></h2>
                    <button @click="loadNews()" class="text-blue-600 text-sm font-medium touch-target px-3 py-1 rounded-lg bg-blue-50 hover:bg-blue-100 transition-colors">
                        <span x-text="language === 'zh' ? '刷新' : 'Refresh'"></span>
                    </button>
                </div>
            </div>
            <div class="p-4">
            
            <div x-show="newsLoading" class="text-center py-4">
                <div class="loading-spinner mx-auto mb-2"></div>
                <p class="text-sm text-gray-600" x-text="language === 'zh' ? '加载新闻中...' : 'Loading news...'"></p>
            </div>
            
            <div x-show="!newsLoading && news && news.length > 0" class="space-y-0">
                <template x-for="article in news.slice(0, 3)" :key="article.id">
                    <div class="news-item">
                        <h3 class="font-semibold text-base mb-2 line-clamp-2">
                            <a :href="article.url" target="_blank" class="hover:underline">
                                <span x-text="language === 'zh' && article.translatedHeadline ? article.translatedHeadline : article.headline"></span>
                            </a>
                        </h3>
                        <p class="text-xs text-gray-600 mb-2 line-clamp-2" x-text="language === 'zh' && article.translatedSummary ? article.translatedSummary : article.summary"></p>
                        <div class="flex items-center justify-between text-xs text-gray-500">
                            <span x-text="article.source"></span>
                            <span x-text="formatNewsDate(article.datetime)"></span>
                        </div>
                    </div>
                </template>
            </div>
            
            <div x-show="!newsLoading && (!news || news.length === 0)" class="text-center py-4 text-gray-500">
                <p class="text-sm" x-text="language === 'zh' ? '暂无相关新闻' : 'No news available'"></p>
            </div>
            </div>
        </div>

        <!-- 快捷操作 -->
        <div x-show="!loading && !error" class="mobile-card">
            <div class="card-header">
                <h2 class="card-title" x-text="language === 'zh' ? '快捷操作' : 'Quick Actions'"></h2>
            </div>
            <div class="p-4">
            <div class="grid grid-cols-2 gap-6">
                <button @click="openYouTubeSearch()" 
                        class="flex flex-col items-center justify-center space-y-3 bg-gradient-to-br from-red-50 to-red-100 hover:from-red-100 hover:to-red-200 active:scale-95 py-6 px-4 rounded-2xl touch-target transition-all duration-300 shadow-lg hover:shadow-xl border border-red-100">
                    <!-- YouTube红色图标 -->
                    <div class="bg-white p-2 rounded-xl shadow-md">
                        <svg class="w-8 h-8" viewBox="0 0 24 24" fill="none">
                            <rect x="2" y="6" width="20" height="12" rx="3" fill="currentColor"/>
                            <path d="M10 8.5L15 12L10 15.5V8.5Z" fill="white"/>
                        </svg>
                    </div>
                    <span class="text-base font-bold" x-text="language === 'zh' ? '相关视频' : 'Videos'"></span>
                </button>
                <button @click="openXueqiuSearch()" 
                        class="flex flex-col items-center justify-center space-y-3 bg-gradient-to-br from-blue-50 to-blue-100 hover:from-blue-100 hover:to-blue-200 active:scale-95 py-6 px-4 rounded-2xl touch-target transition-all duration-300 shadow-lg hover:shadow-xl border border-blue-100">
                    <!-- 雪球蓝色图标 -->
                    <div class="bg-white p-2 rounded-xl shadow-md">
                        <svg class="w-8 h-8" viewBox="0 0 24 24" fill="none">
                            <rect x="2" y="2" width="20" height="20" rx="4" fill="currentColor"/>
                            <circle cx="8" cy="8" r="1.5" fill="white"/>
                            <circle cx="16" cy="8" r="1" fill="white"/>
                            <circle cx="6" cy="14" r="1.2" fill="white"/>
                            <circle cx="12" cy="12" r="1.8" fill="white"/>
                            <circle cx="18" cy="16" r="1" fill="white"/>
                            <path d="M8 8L12 12M12 12L16 8M12 12L6 14M12 12L18 16" stroke="white" stroke-width="0.5" opacity="0.8"/>
                        </svg>
                    </div>
                    <span class="text-base font-bold" x-text="language === 'zh' ? '社区讨论' : 'Community'"></span>
                </button>
            </div>
            </div>
        </div>
    </main>

    <!-- 您的所有JavaScript逻辑保持不变 -->
    <script>
        function mobileStockApp() {
            return {
                language: 'zh',
                symbol: new URLSearchParams(window.location.search).get('symbol') || 'AAPL',
                loading: true,
                chartLoading: false,
                error: null,
                quote: null,
                companyProfile: null,
                candles: null,
                metrics: null,
                chineseName: null,
                selectedPeriod: 'D',
                timePeriods: [
                    { value: 'D', zh: '日线', en: 'Day' },
                    { value: 'W', zh: '周线', en: 'Week' },
                    { value: 'M', zh: '月线', en: 'Month' }
                ],
                chart: null,
                chartCreating: false,
                news: [],
                newsLoading: false,
                lastCandleCall: 0,
                candleCallInterval: 20000,
                candleCache: new Map(),
                cacheExpiry: 300000,

                async init() {
                    const urlParams = new URLSearchParams(window.location.search);
                    const symbolFromUrl = urlParams.get('symbol');
                    
                    if (symbolFromUrl) {
                        this.symbol = symbolFromUrl.toUpperCase();
                    }
                    
                    const savedLang = localStorage.getItem('stock-lang');
                    if (savedLang) this.language = savedLang;
                    
                    await this.initializePageWithStableRendering();
                },

                async initializePageWithStableRendering() {
                    this.loading = true;
                    this.error = null;
                    
                    try {
                        const encodedSymbol = encodeURIComponent(this.symbol);
                        
                        const dataPromises = [
                            fetch(`/api/stock/quote?symbol=${encodedSymbol}`).then(res => this.handleResponse(res)),
                            fetch(`/api/stock/profile?symbol=${encodedSymbol}`).then(res => this.handleResponse(res)),
                            fetch(`/api/stock/metrics?symbol=${encodedSymbol}`).then(res => this.handleResponse(res)),
                            fetch(`/api/stock/chinese-name?symbol=${encodedSymbol}`).then(res => res.json().catch(() => ({}))),
                            this.loadCandlesData(),
                            this.loadNewsData()
                        ];
                        
                        const [quoteData, profileData, metricsData, chineseNameData, candlesData, newsData] = await Promise.all(dataPromises);
                        
                        this.quote = quoteData;
                        this.companyProfile = profileData;
                        this.metrics = metricsData;
                        
                        if (chineseNameData.success && chineseNameData.chinese_name) {
                            this.chineseName = chineseNameData.chinese_name;
                        }
                        
                        this.news = newsData || [];
                        
                        if (this.news.length > 0) {
                            setTimeout(() => {
                                this.translateNewsItems(this.news).catch(error => {
                                    console.error('新闻翻译失败:', error);
                                });
                            }, 500);
                        }
                        
                        console.log('🔍 检查K线数据:', {
                            hasCandlesData: !!candlesData,
                            candlesType: typeof candlesData,
                            hasC: candlesData?.c ? true : false,
                            cLength: candlesData?.c?.length,
                            isArray: Array.isArray(candlesData?.c)
                        });
                        
                        if (candlesData && candlesData.c && Array.isArray(candlesData.c) && candlesData.c.length > 0) {
                            this.candles = candlesData;
                            console.log('✅ K线数据验证通过，准备渲染图表');
                            
                            setTimeout(() => {
                                try {
                                    console.log('🎯 开始在独立事件循环中初始化图表...');
                                    this.renderChartInSeparateTask();
                                    console.log('✅ 图表在独立任务中初始化成功');
                                } catch (error) {
                                    console.error('❌ 最终图表初始化尝试失败:', error);
                                    this.showChartError('图表渲染失败');
                                }
                            }, 100);
                        } else {
                            console.warn('❌ K线数据验证失败:', candlesData);
                            setTimeout(async () => {
                                console.log('🔄 尝试重新加载K线数据...');
                                try {
                                    const retryData = await this.loadCandlesData();
                                    if (retryData && retryData.c && Array.isArray(retryData.c) && retryData.c.length > 0) {
                                        this.candles = retryData;
                                        this.renderChartInSeparateTask();
                                        console.log('✅ 重新加载K线数据成功');
                                    } else {
                                        this.showChartError('暂无K线图数据');
                                    }
                                } catch (error) {
                                    console.error('重新加载K线数据失败:', error);
                                    this.showChartError('K线数据加载失败');
                                }
                            }, 1000);
                        }
                        
                    } catch (error) {
                        console.error('页面初始化失败:', error);
                        this.error = `数据加载失败: ${error.message}`;
                    } finally {
                        this.loading = false;
                    }
                },
                
                async loadCandlesData() {
                    try {
                        const now = Date.now();
                        const cacheKey = `${this.symbol}_${this.selectedPeriod}`;
                        const cachedData = this.candleCache.get(cacheKey);
                        
                        if (cachedData && (now - cachedData.timestamp) < this.cacheExpiry) {
                            console.log('使用缓存的K线数据');
                            return cachedData.data;
                        }
                        
                        const timeSinceLastCall = now - this.lastCandleCall;
                        if (timeSinceLastCall < this.candleCallInterval) {
                            console.log('API调用频率限制，使用缓存数据或跳过');
                            return cachedData ? cachedData.data : null;
                        }
                        
                        this.lastCandleCall = now;
                        
                        const to = Math.floor(Date.now() / 1000);
                        let from;
                        switch (this.selectedPeriod) {
                            case 'W': from = to - (5 * 365 * 24 * 60 * 60); break;
                            case 'M': from = to - (20 * 365 * 24 * 60 * 60); break;
                            default: from = to - (365 * 24 * 60 * 60);
                        }
                        
                        const encodedSymbol = encodeURIComponent(this.symbol);
                        const url = `/api/stock/candles?symbol=${encodedSymbol}&resolution=${this.selectedPeriod}&from=${from}&to=${to}`;
                        const response = await fetch(url);
                        const data = await this.handleResponse(response);
                        
                        if (data && data.c && Array.isArray(data.c) && data.c.length > 0) {
                            this.candleCache.set(cacheKey, { data: data, timestamp: now });
                            return data;
                        } else {
                            console.warn('Invalid candle data received:', data);
                            return null;
                        }
                    } catch (error) {
                        console.error('Failed to load candles data:', error);
                        return null;
                    }
                },
                
                async loadNewsData() {
                    try {
                        const encodedSymbol = encodeURIComponent(this.symbol);
                        const response = await fetch(`/api/stock/news?symbol=${encodedSymbol}`);
                        const data = await this.handleResponse(response);
                        return data || [];
                    } catch (error) {
                        console.error('Failed to load news data:', error);
                        return [];
                    }
                },

                async translateNewsItems(newsItems) {
                    if (!newsItems || newsItems.length === 0) {
                        console.log('📰 没有新闻需要翻译');
                        return;
                    }
                    
                    console.log(`📰 开始翻译 ${newsItems.length} 条新闻...`);
                    
                    for (let i = 0; i < newsItems.length; i++) {
                        const item = newsItems[i];
                        try {
                            const promises = [];
                            
                            if (item.headline) {
                                promises.push(
                                    this.translateWithVolcEngine(item.headline)
                                        .then(translated => {
                                            if (translated && translated !== item.headline) {
                                                item.translatedHeadline = translated;
                                                console.log('✅ 新闻标题翻译成功');
                                            } else {
                                                item.translatedHeadline = item.headline;
                                            }
                                        })
                                        .catch(e => {
                                            console.warn('⚠️ 新闻标题翻译失败，使用原文');
                                            item.translatedHeadline = item.headline;
                                        })
                                );
                            }
                            
                            if (item.summary) {
                                promises.push(
                                    this.translateWithVolcEngine(item.summary)
                                        .then(translated => {
                                            if (translated && translated !== item.summary) {
                                                item.translatedSummary = translated;
                                                console.log('✅ 新闻摘要翻译成功');
                                            } else {
                                                item.translatedSummary = item.summary;
                                            }
                                        })
                                        .catch(e => {
                                            console.warn('⚠️ 新闻摘要翻译失败，使用原文');
                                            item.translatedSummary = item.summary;
                                        })
                                );
                            }
                            
                            await Promise.all(promises);
                            
                            console.log(`✅ 新闻 ${i + 1}/${newsItems.length} 翻译完成`);
                            
                            item.originalHeadline = item.headline;
                            item.originalSummary = item.summary;
                        } catch (error) {
                            console.error(`❌ 新闻 ${i + 1} 翻译失败:`, error);
                            item.translatedHeadline = item.headline;
                            item.translatedSummary = item.summary;
                            item.originalHeadline = item.headline;
                            item.originalSummary = item.summary;
                        }
                    }
                    
                    console.log('🎉 所有新闻翻译处理完成');
                    this.$nextTick(() => {
                        console.log('📱 页面数据已更新');
                    });
                },

                translationCache: new Map(),
                translationInProgress: new Set(),
                
                async translateWithVolcEngine(text) {
                    if (!text || text.trim() === '') {
                        return text;
                    }
                    
                    const cacheKey = `volc_${text}`;
                    if (this.translationCache.has(cacheKey)) {
                        return this.translationCache.get(cacheKey);
                    }
                    
                    if (this.translationInProgress.has(cacheKey)) {
                        return text;
                    }
                    
                    this.translationInProgress.add(cacheKey);
                    
                    try {
                        console.log('🚀 使用火山引擎翻译...');
                        
                        const response = await fetch('/api/translate', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                text: text,
                                targetLang: 'zh'
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }
                        
                        const data = await response.json();
                        const translatedText = data.translatedText || data.translation || '';
                        
                        if (translatedText && translatedText.trim() !== '' && translatedText !== text) {
                            this.translationCache.set(cacheKey, translatedText);
                            this.translationInProgress.delete(cacheKey);
                            console.log('✅ 火山引擎翻译成功');
                            return translatedText;
                        }
                        
                        throw new Error('翻译结果为空或无效');
                        
                    } catch (error) {
                        console.warn('❌ 火山引擎翻译失败:', error.message);
                        this.translationInProgress.delete(cacheKey);
                        return text;
                    }
                },

                renderChartInSeparateTask() {
                    if (this.chartCreating) {
                        console.warn('Chart creation already in progress');
                        return;
                    }
                    
                    this.chartCreating = true;
                    
                    try {
                        const ctx = document.getElementById('mobileStockChart');
                        if (!ctx) {
                            console.error('Canvas element not found');
                            this.showChartError('图表容器未找到');
                            return;
                        }
                        
                        const container = ctx.parentElement;
                        if (!container) {
                            console.error('Chart container not found');
                            this.showChartError('图表容器未找到');
                            return;
                        }
                        
                        const rect = container.getBoundingClientRect();
                        if (rect.width <= 0 || rect.height <= 0) {
                            console.warn('Container size not ready, retrying...', rect);
                            setTimeout(() => {
                                this.chartCreating = false;
                                this.renderChartInSeparateTask();
                            }, 200);
                            return;
                        }
                        
                        if (this.chart) {
                            try {
                                this.chart.destroy();
                            } catch (e) {
                                console.warn('Error destroying existing chart:', e);
                            }
                            this.chart = null;
                        }
                        
                        this.createChart(ctx);
                        
                    } finally {
                        this.chartCreating = false;
                    }
                },
                
                showChartError(message) {
                    const container = document.getElementById('mobileStockChart')?.parentElement;
                    if (container) {
                        container.innerHTML = `
                            <div class="flex items-center justify-center h-full text-gray-500">
                                <div class="text-center">
                                    <p class="mb-2">${message}</p>
                                    <p class="text-sm">${this.language === 'zh' ? '请稍后重试' : 'Please try again later'}</p>
                                </div>
                            </div>
                        `;
                    }
                },

                async translateNews() {
                    try {
                        for (let i = 0; i < Math.min(this.news.length, 3); i++) {
                            const article = this.news[i];
                            if (!article.translatedHeadline && article.headline) {
                                // 翻译标题
                                const titleResponse = await fetch('/api/translate', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ text: article.headline, target: 'zh' })
                                });
                                const titleData = await titleResponse.json();
                                if (titleData.success) {
                                    article.translatedHeadline = titleData.translatedText;
                                }
                            }
                            
                            if (!article.translatedSummary && article.summary) {
                                // 翻译摘要
                                const summaryResponse = await fetch('/api/translate', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ text: article.summary, target: 'zh' })
                                });
                                const summaryData = await summaryResponse.json();
                                if (summaryData.success) {
                                    article.translatedSummary = summaryData.translatedText;
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Translation failed:', error);
                    }
                },

                async changePeriod(newPeriod) {
                    if (this.selectedPeriod === newPeriod) return;
                    
                    if (this.chartLoading || this.chartCreating) {
                        console.warn('Chart operation in progress, ignoring period change');
                        return;
                    }
                    
                    this.selectedPeriod = newPeriod;
                    
                    try {
                        const candlesData = await this.loadCandlesData();
                        if (candlesData && candlesData.c && Array.isArray(candlesData.c) && candlesData.c.length > 0) {
                            this.candles = candlesData;
                            
                            setTimeout(() => {
                                this.renderChartInSeparateTask();
                            }, 0);
                        } else {
                            this.showChartError('暂无该周期的K线数据');
                        }
                    } catch (error) {
                        console.error('Period change failed:', error);
                        this.showChartError('切换周期失败');
                    }
                },

                createChart(ctx) {
                    if (!this.candles || typeof this.candles !== 'object') {
                        console.warn('Cannot create chart: candles data is null or invalid');
                        this.showChartError('K线数据无效');
                        return;
                    }
                    
                    if (!Array.isArray(this.candles.t) || !Array.isArray(this.candles.c) || 
                        this.candles.t.length === 0 || this.candles.c.length === 0 ||
                        this.candles.t.length !== this.candles.c.length) {
                        console.warn('Cannot create chart: invalid candle data structure');
                        this.showChartError('K线数据格式错误');
                        return;
                    }
                    
                    try {
                        const cleanedData = [];
                        const cleanedLabels = [];
                        
                        for (let i = 0; i < this.candles.t.length; i++) {
                            const timestamp = this.candles.t[i];
                            const price = this.candles.c[i];
                            
                            if (typeof timestamp === 'number' && timestamp > 0 &&
                                typeof price === 'number' && !isNaN(price) && price > 0) {
                                cleanedData.push(price);
                                const date = new Date(timestamp * 1000);
                                cleanedLabels.push(date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' }));
                            }
                        }
                        
                        if (cleanedData.length === 0) {
                            console.warn('Cannot create chart: no valid data points after cleaning');
                            this.showChartError('没有有效的K线数据');
                            return;
                        }
                        
                        const isPositive = this.quote && this.quote.d >= 0;
                        const color = isPositive ? '#22c55e' : '#ef4444';
                        
                        if (!ctx.getContext) {
                            console.error('Invalid canvas context');
                            this.showChartError('Canvas上下文无效');
                            return;
                        }
                        
                        const container = ctx.parentElement;
                        const rect = container.getBoundingClientRect();
                        ctx.width = rect.width;
                        ctx.height = rect.height;
                        

                        this.chart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: cleanedLabels,
                                datasets: [{
                                    label: this.symbol,
                                    data: cleanedData,
                                    borderColor: color,
                                    backgroundColor: 'transparent',
                                    borderWidth: 2,
                                    pointRadius: 0,
                                    pointHoverRadius: 4,
                                    tension: 0.1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { display: false } },
                                scales: {
                                    x: { display: true, grid: { display: false }, ticks: { maxTicksLimit: 6 } },
                                    y: { display: true, position: 'right', grid: { color: '#f1f5f9' } }
                                },
                                interaction: { intersect: false, mode: 'index' }
                            }
                        });
                        
                    } catch (error) {
                        console.error('Chart.js Error Details:', error);
                        this.chart = null;
                        const container = ctx?.parentElement;
                        if (container) {
                            container.innerHTML = `<div class="flex items-center justify-center h-full text-gray-500"><div class="text-center"><p class="mb-2">${this.language === 'zh' ? '图表加载失败' : 'Chart loading failed'}</p><p class="text-sm">${this.language === 'zh' ? '请稍后重试' : 'Please try again later'}</p></div></div>`;
                        }
                    }
                },

                async handleResponse(response) {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return await response.json();
                },

                getDisplayName() {
                    return this.chineseName || this.companyProfile?.name || this.symbol;
                },

                getChangeClass() {
                    if (!this.quote?.d) return '';
                    return this.quote.d >= 0 ? 'change-positive' : 'change-negative';
                },

                formatPrice(price) { if (!price) return 'N/A'; return `$${parseFloat(price).toFixed(2)}`; },
                formatChange(change) { if (!change) return 'N/A'; const sign = change >= 0 ? '+' : ''; return `${sign}$${parseFloat(change).toFixed(2)}`; },
                formatChangePercent(changePercent) { if (!changePercent) return 'N/A'; const sign = changePercent >= 0 ? '+' : ''; return `${sign}${parseFloat(changePercent).toFixed(2)}%`; },
                formatMarketCap(marketCap) { if (!marketCap) return 'N/A'; const T = 1000000000000, B = 100; if (marketCap >= T) { return `${(marketCap / T).toFixed(2)}万亿`; } else { return `${(marketCap / B).toFixed(0)}亿`; } },
                formatVolume(volume) { if (!volume) return 'N/A'; if (volume >= 1000000) { return `${(volume / 1000000).toFixed(1)}M`; } else if (volume >= 1000) { return `${(volume / 1000).toFixed(1)}K`; } return volume.toString(); },
                formatRatio(ratio) { if (!ratio) return 'N/A'; return parseFloat(ratio).toFixed(2); },
                formatTime(timestamp) { if (!timestamp) return 'N/A'; const date = new Date(timestamp * 1000); return date.toLocaleString('zh-CN'); },
                formatNewsDate(timestamp) { if (!timestamp) return ''; const date = new Date(timestamp * 1000); const now = new Date(); const diffHours = Math.floor((now - date) / 3600000); if (diffHours < 1) return '刚刚'; if (diffHours < 24) return `${diffHours}小时前`; if (diffHours < 48) return '1天前'; return date.toLocaleDateString('zh-CN'); },
                toggleLanguage() { this.language = this.language === 'zh' ? 'en' : 'zh'; localStorage.setItem('stock-lang', this.language); },
                goBack() { if (window.history.length > 1) { window.history.back(); } else { window.location.href = '/'; } },
                openYouTubeSearch() { const query = encodeURIComponent(`${this.symbol} ${this.companyProfile?.name || ''} stock analysis`); window.open(`https://www.youtube.com/results?search_query=${query}`, '_blank'); },
                openXueqiuSearch() { const query = encodeURIComponent(this.symbol); window.open(`https://xueqiu.com/S/${query}`, '_blank'); }
            };
        }
    </script>
</body>
</html>