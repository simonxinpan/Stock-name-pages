# K线图频率控制优化说明

## 问题描述
K线图数据虽然已连接Polygon.io API，但由于Polygon API有调用频率限制（低于1分钟5次），导致K线图"一闪而过"，无法正常显示。

## 解决方案

### 1. 频率控制机制
- **调用间隔**: 设置20秒的API调用间隔，确保符合Polygon API限制
- **智能等待**: 如果距离上次调用不足20秒，自动延迟执行
- **状态提示**: 在UI中显示API调用状态和频率限制提示

### 2. 缓存机制
- **数据缓存**: 使用Map缓存K线数据，避免重复请求
- **缓存时效**: 设置5分钟缓存过期时间
- **智能复用**: 切换时间周期时优先使用缓存数据

### 3. 错误处理优化
- **重试机制**: API调用失败时重置调用时间，允许立即重试
- **日志记录**: 详细的控制台日志，便于调试和监控
- **用户反馈**: 清晰的加载状态和错误提示

## 技术实现

### 核心变量
```javascript
lastCandleCall: 0,           // 上次API调用时间
candleCallInterval: 20000,   // 20秒调用间隔
candleCache: new Map(),      // K线数据缓存
cacheExpiry: 300000,         // 5分钟缓存过期
```

### 主要功能
1. **loadCandles()**: 增强的K线数据加载函数
   - 频率控制检查
   - 缓存数据复用
   - 智能延迟执行
   - 数据缓存存储

2. **changePeriod()**: 优化的周期切换函数
   - 优先使用缓存数据
   - 减少不必要的API调用

3. **cleanExpiredCache()**: 缓存清理机制
   - 定期清理过期缓存
   - 防止内存泄漏

## 用户体验改进

### 状态指示器
- 📊 加载中提示
- ⏱️ API频率限制提示
- 支持中英文切换

### 控制台日志
- 初始化提示: "初始化股票应用，API调用间隔：20秒"
- 缓存使用: "使用缓存的K线数据"
- 频率控制: "API调用频率限制，等待 X 秒..."
- 数据加载: "正在获取K线数据: SYMBOL (PERIOD)"
- 成功提示: "K线数据加载成功: X 个数据点"

## 部署说明

### 文件修改
- `public/index.html`: 主要修改文件，包含所有频率控制逻辑

### 测试验证
1. 本地测试确认频率控制正常工作
2. 缓存机制有效减少API调用
3. UI状态提示清晰可见
4. 错误处理机制完善

### 下一步
1. 将代码提交到V9分支
2. 部署到Vercel生产环境
3. 验证线上K线图正常显示
4. 监控API调用频率和缓存效果

## 预期效果
- ✅ K线图稳定显示，不再"一闪而过"
- ✅ API调用频率控制在安全范围内
- ✅ 用户体验流畅，加载状态清晰
- ✅ 缓存机制提升响应速度
- ✅ 错误处理完善，系统稳定性提升

---

**优化完成时间**: 2024年12月
**技术负责人**: FE-Core
**状态**: 已完成本地测试，待部署验证